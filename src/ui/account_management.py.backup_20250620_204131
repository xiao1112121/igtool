import os
import sys
import time
import random
import json
import threading
import queue
from datetime import datetime
from typing import Dict, List, Optional, Tuple, Any, Union
import traceback  # ThÃªm import nÃ y
from PySide6.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QPushButton, 
    QLabel, QLineEdit, QTextEdit, QFileDialog, QMessageBox,
    QProgressBar, QComboBox, QCheckBox, QSpinBox, QGroupBox,
    QScrollArea, QFrame, QSplitter, QTabWidget, QApplication,
    QTableWidget, QTableWidgetItem, QAbstractItemView, QHeaderView, QSizePolicy, QStyledItemDelegate, QMenu, QProgressDialog, QInputDialog, QSlider)
from PySide6.QtCore import Qt, QThread, Signal, QTimer, QSize, QModelIndex, QRect, QEvent, QMetaObject, Slot
from PySide6.QtGui import QFont, QIcon, QPixmap, QColor, QPalette, QPainter, QPen, QGuiApplication, QAction
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException, NoSuchElementException
from webdriver_manager.chrome import ChromeDriverManager
from seleniumwire import webdriver as wire_webdriver
from seleniumwire.utils import decode
from twocaptcha import TwoCaptcha
from src.ui.utils import random_delay, wait_for_element, wait_for_element_clickable, retry_operation
from src.ui.context_menus import AccountContextMenu
from concurrent.futures import ThreadPoolExecutor, as_completed
from selenium.webdriver.common.keys import Keys

class CheckboxDelegate(QStyledItemDelegate):
    # Sá»­ dá»¥ng má»™t UserRole tÃ¹y chá»‰nh Ä‘á»ƒ trÃ¡nh xung Ä‘á»™t vá»›i Qt.CheckStateRole máº·c Ä‘á»‹nh
    CheckboxStateRole = Qt.UserRole + 1
    checkbox_clicked = Signal(int, bool)  # ThÃªm tÃ­n hiá»‡u má»›i: row, new_state

    def paint(self, painter: QPainter, option, index: QModelIndex):
        super().paint(painter, option, index)  # Gá»i phÆ°Æ¡ng thá»©c paint cá»§a lá»›p cha Ä‘á»ƒ váº½ ná»n máº·c Ä‘á»‹nh (bao gá»“m cáº£ mÃ u chá»n)
        # Láº¥y tráº¡ng thÃ¡i checkbox tá»« model báº±ng UserRole tÃ¹y chá»‰nh
        check_state_data = index.data(self.CheckboxStateRole)
        is_checked = bool(check_state_data)  # Convert to boolean

        # TÃ­nh toÃ¡n vá»‹ trÃ­ vÃ  kÃ­ch thÆ°á»›c cho checkbox 15x15px, cÄƒn giá»¯a trong Ã´
        checkbox_size = 14 
        rect = option.rect
        x = rect.x() + (rect.width() - checkbox_size) // 2
        y = rect.y() + (rect.height() - checkbox_size) // 2
        checkbox_rect = QRect(x, y, checkbox_size, checkbox_size)

        painter.save()
        painter.setRenderHint(QPainter.Antialiasing)

        # Váº½ ná»n vÃ  viá»n cá»§a checkbox
        if is_checked:
            painter.setBrush(QColor("#1976D2"))  # MÃ u xanh lam khi chá»n
            painter.setPen(QColor("#1976D2"))
        else:
            painter.setBrush(Qt.white)  # Ná»n tráº¯ng khi khÃ´ng chá»n
            painter.setPen(QColor("#CCCCCC"))  # Viá»n xÃ¡m khi khÃ´ng chá»n

        painter.drawRoundedRect(checkbox_rect, 2, 2)  # Váº½ hÃ¬nh vuÃ´ng bo gÃ³c

        # Váº½ dáº¥u tÃ­ch náº¿u Ä‘Ã£ chá»n
        if is_checked:
            # Váº½ dáº¥u tÃ­ch tráº¯ng Ä‘Æ¡n giáº£n
            painter.setPen(QPen(Qt.white, 2))  # BÃºt mÃ u tráº¯ng, Ä‘á»™ dÃ y 2
            # ÄÆ°á»ng chÃ©o thá»© nháº¥t cá»§a dáº¥u tÃ­ch (tá»« dÆ°á»›i lÃªn)
            painter.drawLine(x + 3, y + 7, x + 6, y + 10)
            # ÄÆ°á»ng chÃ©o thá»© hai cá»§a dáº¥u tÃ­ch (tá»« Ä‘iá»ƒm giá»¯a lÃªn trÃªn)
            painter.drawLine(x + 6, y + 10, x + 12, y + 4)

        painter.restore()

    def editorEvent(self, event, model, option, index: QModelIndex):
        if event.type() == QEvent.MouseButtonPress and event.button() == Qt.LeftButton:
            # Láº¥y tráº¡ng thÃ¡i hiá»‡n táº¡i tá»« UserRole tÃ¹y chá»‰nh
            current_state = index.data(self.CheckboxStateRole)
            new_state = not bool(current_state)

            # Cáº­p nháº­t tráº¡ng thÃ¡i trong model báº±ng UserRole tÃ¹y chá»‰nh
            model.setData(index, new_state, self.CheckboxStateRole)

            # PhÃ¡t tÃ­n hiá»‡u khi checkbox Ä‘Æ°á»£c click
            self.checkbox_clicked.emit(index.row(), new_state)
            return True  # ÄÃ£ xá»­ lÃ½ sá»± kiá»‡n
        return False  # Quan trá»ng: Tráº£ vá» False Ä‘á»ƒ cÃ¡c sá»± kiá»‡n khÃ´ng pháº£i click Ä‘Æ°á»£c xá»­ lÃ½ máº·c Ä‘á»‹nh

class CheckableHeaderView(QHeaderView):
    toggleAllCheckboxes = Signal(bool)  # TÃ­n hiá»‡u Ä‘á»ƒ thÃ´ng bÃ¡o khi checkbox trong header Ä‘Æ°á»£c toggle

    def __init__(self, orientation, parent=None):
        super().__init__(orientation, parent)
        self._checked = False  # Tráº¡ng thÃ¡i cá»§a checkbox trong header
        self.setSectionsClickable(True)

    def paintSection(self, painter, rect, logicalIndex):
        # LuÃ´n váº½ ná»n/viá»n 3D máº·c Ä‘á»‹nh trÆ°á»›c
        super().paintSection(painter, rect, logicalIndex)
        if logicalIndex == 0:  # Cá»™t Ä‘áº§u tiÃªn lÃ  cá»™t checkbox
            checkbox_size = 14  # KÃ­ch thÆ°á»›c cá»§a checkbox
            x = rect.x() + (rect.width() - checkbox_size) // 2
            y = rect.y() + (rect.height() - checkbox_size) // 2
            checkbox_rect = QRect(x, y, checkbox_size, checkbox_size)

            painter.save()
            painter.setRenderHint(QPainter.Antialiasing)
            # Váº½ ná»n vÃ  viá»n cá»§a checkbox
            if self._checked:
                painter.setBrush(QColor("#1976D2"))
                painter.setPen(QColor("#1976D2"))
            else:
                painter.setBrush(Qt.white)
                painter.setPen(QColor("#CCCCCC"))
            painter.drawRoundedRect(checkbox_rect, 2, 2)
            # Váº½ dáº¥u tÃ­ch náº¿u Ä‘Ã£ chá»n
            if self._checked:
                painter.setPen(QPen(Qt.white, 2))
                painter.drawLine(x + 3, y + 7, x + 6, y + 10)
                painter.drawLine(x + 6, y + 10, x + 12, y + 4)
            painter.restore()
        else:
            # Gá»i phÆ°Æ¡ng thá»©c gá»‘c Ä‘á»ƒ váº½ pháº§n cÃ²n láº¡i cá»§a header cho cÃ¡c cá»™t khÃ¡c
            super().paintSection(painter, rect, logicalIndex)

    def mousePressEvent(self, event):
        if self.logicalIndexAt(event.pos()) == 0 and event.button() == Qt.LeftButton:  # Chá»‰ xá»­ lÃ½ click trÃªn cá»™t Ä‘áº§u tiÃªn
            self._checked = not self._checked
            self.toggleAllCheckboxes.emit(self._checked)
            self.viewport().update()  # Cáº­p nháº­t láº¡i giao diá»‡n header Ä‘á»ƒ hiá»ƒn thá»‹ tráº¡ng thÃ¡i checkbox má»›i
            event.accept()  # Cháº¥p nháº­n sá»± kiá»‡n Ä‘á»ƒ ngÄƒn xá»­ lÃ½ máº·c Ä‘á»‹nh
        else:
            super().mousePressEvent(event)


class AccountManagementTab(QWidget):
    # Äá»‹nh nghÄ©a tÃ­n hiá»‡u Ä‘á»ƒ thÃ´ng bÃ¡o khi dá»¯ liá»‡u proxy Ä‘Æ°á»£c cáº­p nháº­t
    proxy_updated = Signal()
    # ThÃªm signal Ä‘á»ƒ cáº­p nháº­t tráº¡ng thÃ¡i tá»« thread
    status_updated = Signal(str, str)  # username, status
    # â­ THÃŠM TÃN HIá»†U Äá»’NG Bá»˜ FOLDERS
    folders_updated = Signal()

    USER_AGENTS = [
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36",
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36",
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36",
        "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36",
        "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36",
        "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36"
    ]

    LANGUAGES = [
        "en-US,en;q=0.9",  # English (United States), English
        "vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7",  # Vietnamese, English
        "fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7",  # French, English
        "de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7",  # German, English
        "ja-JP,ja;q=0.9,en-US;q=0.8,en;q=0.7"  # Japanese, English
    ]

    PROXY_USAGE_THRESHOLD = 5  # NgÆ°á»¡ng sá»­ dá»¥ng proxy trÆ°á»›c khi xoay vÃ²ng
    RECAPTCHA_RETRY_COUNT = 3  # Sá»‘ láº§n thá»­ láº¡i khi gáº·p reCAPTCHA
    RECAPTCHA_WAIT_TIME = 10  # Thá»i gian chá» giá»¯a cÃ¡c láº§n thá»­ (giÃ¢y)

    def __init__(self, proxy_tab_instance=None, parent=None):
        super().__init__(parent)
        self.proxy_tab = proxy_tab_instance
        self.accounts_file = "accounts.json"
        self.folder_map_file = os.path.join("data", "folder_map.json")  # Sá»­a láº¡i Ä‘Æ°á»ng dáº«n Ä‘Ãºng
        self.accounts = self.load_accounts()
        self.folder_map = self.load_folder_map()
        self.active_drivers = []
        self.stealth_mode_enabled = False
        self.proxies = self.load_proxies()
        self.init_ui()
        self.update_account_table()
        # Äá»c tráº¡ng thÃ¡i sá»­ dá»¥ng proxy tá»« file (náº¿u cÃ³)
        self.settings_file = "account_settings.json"
        self.use_proxy = True
        try:
            if os.path.exists(self.settings_file):
                with open(self.settings_file, "r", encoding="utf-8") as f:
                    settings = json.load(f)
                    self.use_proxy = settings.get("use_proxy", True)
        except Exception as e:
            print(f"[WARN] KhÃ´ng thá»ƒ Ä‘á»c tráº¡ng thÃ¡i sá»­ dá»¥ng proxy: {e}")
        # Thay tháº¿ checkbox báº±ng drag switch (QSlider)
        self.proxy_switch_layout = QHBoxLayout()
        self.proxy_switch_label = QLabel("Proxy: OFF")
        self.proxy_switch_slider = QSlider(Qt.Horizontal)
        self.proxy_switch_slider.setMinimum(0)
        self.proxy_switch_slider.setMaximum(1)
        self.proxy_switch_slider.setSingleStep(1)
        self.proxy_switch_slider.setFixedWidth(80)
        self.proxy_switch_slider.setValue(1 if self.use_proxy else 0)
        self.proxy_switch_layout.addWidget(self.proxy_switch_label)
        self.proxy_switch_layout.addWidget(self.proxy_switch_slider)
        self.sidebar_layout.addLayout(self.proxy_switch_layout)
        self.proxy_switch_slider.valueChanged.connect(self.on_proxy_switch_changed)
        self.update_proxy_switch_label()
        # Káº¿t ná»‘i signal status_updated Ä‘á»ƒ cáº­p nháº­t tá»« thread
        self.status_updated.connect(self.on_status_updated)

    def init_driver(self, proxy=None, username=None):
        print("[DEBUG] Báº¯t Ä‘áº§u khá»Ÿi táº¡o driver...")
        from selenium.webdriver.chrome.options import Options
        options = Options()
        
        # áº¨N THANH Äá»ŠA CHá»ˆ - Sá»¬ Dá»¤NG APP MODE Vá»šI KÃCH THÆ¯á»šC NHá»
        options.add_argument("--app=https://www.instagram.com/")
        
        # âš¡ Tá»I Æ¯U: Minimal Chrome args cho khá»Ÿi Ä‘á»™ng nhanh
        options.add_experimental_option("excludeSwitches", ["enable-automation"])
        options.add_experimental_option("useAutomationExtension", False)
        options.add_argument("--disable-blink-features=AutomationControlled")
        options.add_argument("--disable-infobars")
        options.add_argument("--disable-notifications")
        options.add_argument("--disable-extensions")
        options.add_argument("--no-default-browser-check")
        options.add_argument("--no-first-run")
        # âš¡ ThÃªm args cho tá»‘c Ä‘á»™
        options.add_argument("--disable-dev-shm-usage")
        options.add_argument("--disable-gpu")
        options.add_argument("--disable-background-networking")
        options.add_argument("--disable-sync")
        
        # Táº¯t popup lÆ°u máº­t kháº©u, dá»‹ch, cookie, v.v.
        prefs = {
            "credentials_enable_service": False,
            "profile.password_manager_enabled": False,
            "translate": {"enabled": False},
            "intl.accept_languages": "en,en_US",
            "profile.default_content_setting_values.notifications": 2,
            "profile.default_content_setting_values.automatic_downloads": 1,
            "profile.default_content_setting_values.popups": 2,
            "profile.default_content_setting_values.geolocation": 2,
            # Táº¯t popup khÃ´i phá»¥c trang vÃ  session restore
            "session.restore_on_startup": 4,  # 4 = khÃ´ng khÃ´i phá»¥c
            "profile.exit_type": "Normal",
            "profile.exited_cleanly": True,
            "browser.show_home_button": False,
            "browser.startup_page": 1,  # 1 = blank page
        }
        options.add_experimental_option("prefs", prefs)
        
        # Táº¯t cÃ¡c popup vÃ  khÃ´i phá»¥c session
        options.add_argument("--disable-session-crashed-bubble")
        options.add_argument("--disable-infobars")
        options.add_argument("--disable-restore-session-state")
        options.add_argument("--disable-background-timer-throttling")
        options.add_argument("--disable-backgrounding-occluded-windows")
        options.add_argument("--disable-renderer-backgrounding")
        options.add_argument("--disable-features=TranslateUI,VizDisplayCompositor")
        
        # User agent vÃ  ngÃ´n ngá»¯
        random_user_agent = random.choice(self.USER_AGENTS)
        options.add_argument(f"user-agent={random_user_agent}")
        random_language = random.choice(self.LANGUAGES)
        options.add_argument(f"--lang={random_language}")
        options.add_argument(f"--accept-lang={random_language}")
        print(f"[DEBUG] Sá»­ dá»¥ng User-Agent: {random_user_agent}")
        print(f"[DEBUG] Sá»­ dá»¥ng NgÃ´n ngá»¯: {random_language}")
        
        # Cháº¿ Ä‘á»™ áº©n danh náº¿u Ä‘Æ°á»£c báº­t
        if self.stealth_mode_enabled:
            options.add_argument("--incognito")
            print("[DEBUG] Cháº¿ Ä‘á»™ áº©n danh Ä‘Æ°á»£c báº­t.")
        
        # Äáº£m báº£o hiá»ƒn thá»‹ giao diá»‡n desktop Instagram (khÃ´ng mobile)
        options.add_argument("--disable-mobile-emulation")
        options.add_argument("--force-device-scale-factor=1")
        
        # KÃ­ch thÆ°á»›c cá»­a sá»• nhá» gá»n 450x380px
        options.add_argument("--window-size=450,380")
        
        # Cáº¥u hÃ¬nh proxy
        proxy_options = {}
        if proxy: 
            print(f"[DEBUG] Proxy Ä‘Æ°á»£c cung cáº¥p: {proxy}")
            proxy_parts = proxy.split(':')
            if len(proxy_parts) == 4:
                proxy_ip_port = f"{proxy_parts[0]}:{proxy_parts[1]}"
                proxy_user = proxy_parts[2]
                proxy_pass = proxy_parts[3]
                proxy_options = {
                    'proxy': {
                        'http': f'http://{proxy_user}:{proxy_pass}@{proxy_ip_port}',
                        'https': f'https://{proxy_user}:{proxy_pass}@{proxy_ip_port}',
                        'no_proxy': 'localhost,127.0.0.1' 
                    }
                }
                print(f"[DEBUG] Sá»­ dá»¥ng proxy cÃ³ xÃ¡c thá»±c vá»›i selenium-wire: {proxy_ip_port}")
            elif len(proxy_parts) == 2:
                proxy_ip_port = f"{proxy_parts[0]}:{proxy_parts[1]}"
                proxy_options = {
                    'proxy': {
                        'http': f'http://{proxy_ip_port}',
                        'https': f'https://{proxy_ip_port}'
                    }
                }
                print(f"[DEBUG] Sá»­ dá»¥ng proxy khÃ´ng xÃ¡c thá»±c vá»›i selenium-wire: {proxy_ip_port}")
            else:
                print(f"[WARN] Äá»‹nh dáº¡ng proxy khÃ´ng há»£p lá»‡, bá» qua: {proxy}")
                proxy = None
        else:
            print("[DEBUG] KhÃ´ng cÃ³ proxy Ä‘Æ°á»£c cung cáº¥p")
        
        print("[DEBUG] Äang khá»Ÿi táº¡o Chrome driver...")
        
        # ThÃªm user-data-dir riÃªng cho tá»«ng tÃ i khoáº£n náº¿u cÃ³ username
        if username:
            profile_dir = os.path.abspath(f'sessions/{username}_profile')
            os.makedirs(profile_dir, exist_ok=True)
            options.add_argument(f'--user-data-dir={profile_dir}')
        
        try:
            driver = wire_webdriver.Chrome(seleniumwire_options=proxy_options, options=options)
            print("[DEBUG] Chrome app mode driver Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o thÃ nh cÃ´ng")
            return driver
        except Exception as e:
            print(f"[ERROR] Lá»—i khi khá»Ÿi táº¡o Chrome driver: {str(e)}")
            raise

    def init_ui(self):
        main_layout = QHBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0)  # Remove margins
        main_layout.setSpacing(0)  # Remove spacing

        # Sidebar on the left (15%)
        sidebar_widget = QWidget()
        self.sidebar_layout = QVBoxLayout(sidebar_widget)
        self.sidebar_layout.setContentsMargins(10, 10, 10, 10)
        self.sidebar_layout.setSpacing(10)

        # Functions
        btn_add_account = QPushButton("ThÃªm tÃ i khoáº£n")
        btn_add_account.clicked.connect(self.add_account)
        self.sidebar_layout.addWidget(btn_add_account)

        btn_import_accounts = QPushButton("Import .txt/.csv")
        btn_import_accounts.clicked.connect(self.import_accounts)
        self.sidebar_layout.addWidget(btn_import_accounts)

        btn_add_folder = QPushButton("Quáº£n lÃ½ thÆ° má»¥c")
        btn_add_folder.clicked.connect(self.open_folder_manager)
        self.sidebar_layout.addWidget(btn_add_folder)

        self.sidebar_layout.addStretch()  # Add stretch to push buttons to top

        main_layout.addWidget(sidebar_widget, stretch=15)

        # Right panel (85%)
        right_panel = QWidget()
        right_layout = QVBoxLayout(right_panel)
        right_layout.setContentsMargins(0, 0, 0, 0)  # Remove margins
        right_layout.setSpacing(0)  # Remove spacing

        # Toolbar placed in QFrame for alignment
        toolbar_frame = QFrame()
        toolbar_frame.setStyleSheet("QFrame { padding-top: 6px; padding-bottom: 6px; }\n")
        toolbar_layout = QHBoxLayout(toolbar_frame)
        toolbar_layout.setSpacing(8)
        toolbar_layout.setContentsMargins(0, 0, 0, 0)

        # ComboBox for Category
        self.category_combo = QComboBox()
        self.category_combo.addItem("Táº¥t cáº£")
        self.load_folder_list_to_combo()  # Load folders into combobox
        self.category_combo.currentIndexChanged.connect(self.on_folder_changed)
        self.category_combo.setFixedSize(200, 30)  # KÃ­ch thÆ°á»›c 200x35px
        toolbar_layout.addWidget(self.category_combo)

        # Äáº©y cÃ¡c widget trÆ°á»›c sang trÃ¡i
        toolbar_layout.addStretch(1)
        self.search_input = QLineEdit()
        self.search_input.setPlaceholderText("TÃ¬m kiáº¿m tÃ i khoáº£n...")
        self.search_input.textChanged.connect(self.filter_accounts)
        self.search_input.setFixedWidth(180)
        self.search_input.setFixedHeight(35)
        toolbar_layout.addWidget(self.search_input)

        btn_search = QPushButton("ğŸ”")
        btn_search.clicked.connect(lambda: self.filter_accounts(self.search_input.text()))
        btn_search.setFixedSize(50, 35)
        btn_search.setProperty("role", "main")
        btn_search.setProperty("color", "blue")
        toolbar_layout.addWidget(btn_search)

        right_layout.addWidget(toolbar_frame)

        # Account table
        self.account_table = QTableWidget()
        self.account_table.setColumnCount(11)  # â­ TÄƒng lÃªn 11 cá»™t Ä‘á»ƒ thÃªm Permanent Proxy
        self.account_table.setHorizontalHeaderLabels([
            "", "STT", "TÃªn Ä‘Äƒng nháº­p", "Máº­t kháº©u", "Tráº¡ng thÃ¡i", 
            "Proxy", "Proxy VV", "Tráº¡ng thÃ¡i Proxy", "Follower", "Following", "HÃ nh Ä‘á»™ng cuá»‘i"
        ])

        # Thiáº¿t láº­p delegate cho cá»™t "Chá»n"
        self.checkbox_delegate = CheckboxDelegate(self)
        self.account_table.setItemDelegateForColumn(0, self.checkbox_delegate)
        # Káº¿t ná»‘i tÃ­n hiá»‡u checkbox_clicked tá»« delegate
        self.checkbox_delegate.checkbox_clicked.connect(self.on_checkbox_clicked)

        # Thay tháº¿ QHeaderView máº·c Ä‘á»‹nh báº±ng CheckableHeaderView
        self.header_checkbox = CheckableHeaderView(Qt.Horizontal, self.account_table)
        self.account_table.setHorizontalHeader(self.header_checkbox)
        header = self.header_checkbox  # GÃ¡n láº¡i biáº¿n header Ä‘á»ƒ cÃ¡c dÃ²ng code sau váº«n sá»­ dá»¥ng Ä‘Æ°á»£c

        header.setSectionResizeMode(0, QHeaderView.Fixed)  # Cá»™t "Chá»n"
        self.account_table.setColumnWidth(0, 29)
        header.setSectionResizeMode(1, QHeaderView.Fixed)  # Cá»™t "STT"
        self.account_table.setColumnWidth(1, 29)  # Äáº·t chiá»u rá»™ng cá»™t STT thÃ nh 29px
        header.setSectionResizeMode(2, QHeaderView.Fixed)  # Cá»™t "TÃªn Ä‘Äƒng nháº­p" - Chuyá»ƒn vá» Fixed
        self.account_table.setColumnWidth(2, 150)  # Äáº·t chiá»u rá»™ng cá»‘ Ä‘á»‹nh
        header.setSectionResizeMode(3, QHeaderView.Fixed)  # Cá»™t "Máº­t kháº©u" - Chuyá»ƒn vá» Fixed
        self.account_table.setColumnWidth(3, 150)  # Äáº·t chiá»u rá»™ng cá»‘ Ä‘á»‹nh
        header.setSectionResizeMode(4, QHeaderView.Fixed)  # Cá»™t "Tráº¡ng thÃ¡i"
        self.account_table.setColumnWidth(4, 120)  # Giá»¯ nguyÃªn chiá»u rá»™ng
        header.setSectionResizeMode(5, QHeaderView.Fixed)  # Cá»™t "Proxy" - Chuyá»ƒn vá» Fixed
        self.account_table.setColumnWidth(5, 150)  # Äáº·t chiá»u rá»™ng cá»‘ Ä‘á»‹nh (giáº£m Ä‘á»ƒ cÃ³ chá»— cho Permanent Proxy)
        header.setSectionResizeMode(6, QHeaderView.Fixed)  # â­ Cá»™t "Permanent Proxy"
        self.account_table.setColumnWidth(6, 120)  # Proxy VV - chiá»u rá»™ng vá»«a pháº£i
        header.setSectionResizeMode(7, QHeaderView.Fixed)  # Cá»™t "Tráº¡ng thÃ¡i Proxy"
        self.account_table.setColumnWidth(7, 120)  # Giáº£m chiá»u rá»™ng
        header.setSectionResizeMode(8, QHeaderView.Fixed)  # Cá»™t "Follower"
        self.account_table.setColumnWidth(8, 79)
        header.setSectionResizeMode(9, QHeaderView.Fixed)  # Cá»™t "Following"
        self.account_table.setColumnWidth(9, 79)
        header.setSectionResizeMode(10, QHeaderView.Stretch)  # Cá»™t "HÃ nh Ä‘á»™ng cuá»‘i" - Giá»¯ nguyÃªn Stretch
        self.account_table.verticalHeader().setDefaultSectionSize(40)
        self.account_table.horizontalHeader().setFixedHeight(40)

        # Äáº£m báº£o cá»™t cuá»‘i cÃ¹ng kÃ©o giÃ£n Ä‘á»ƒ hiá»ƒn thá»‹ Ä‘áº§y Ä‘á»§ ná»™i dung
        header.setStretchLastSection(True)

        # Thiáº¿t láº­p cÄƒn lá» cho cÃ¡c tiÃªu Ä‘á» cá»™t
        self.account_table.horizontalHeader().setDefaultAlignment(Qt.AlignHCenter | Qt.AlignVCenter)

        self.account_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        # â­ Enable editing chá»‰ cho má»™t sá»‘ cá»™t cá»¥ thá»ƒ
        self.account_table.setEditTriggers(QTableWidget.DoubleClicked | QTableWidget.EditKeyPressed)  # Enable editing
        self.account_table.setContextMenuPolicy(Qt.CustomContextMenu)
        self.account_table.customContextMenuRequested.connect(self.show_context_menu)
        self.account_table.itemChanged.connect(self.handle_item_changed)  # Connect itemChanged signal
        self.account_table.verticalHeader().setVisible(False)  # áº¨n cá»™t sá»‘ thá»© tá»± bÃªn trÃ¡i
        self.account_table.itemDoubleClicked.connect(self.on_table_item_double_clicked)  # Connect double click signal

        right_layout.addWidget(self.account_table)
        # ThÃªm label thá»‘ng kÃª dÆ°á»›i báº£ng tÃ i khoáº£n (tÃ¡ch riÃªng)
        self.stats_label = QLabel()
        self.stats_label.setAlignment(Qt.AlignLeft | Qt.AlignVCenter)
        self.stats_label.setStyleSheet("font-size: 15px; font-weight: bold; padding: 8px 12px;")
        right_layout.addWidget(self.stats_label)
        main_layout.addWidget(right_panel, stretch=85)

        # Káº¿t ná»‘i tÃ­n hiá»‡u toggleAllCheckboxes tá»« CheckableHeaderView
        self.header_checkbox.toggleAllCheckboxes.connect(self.toggle_all_accounts_selection)

    def load_accounts(self):
        if os.path.exists(self.accounts_file):
            try:
                with open(self.accounts_file, 'r', encoding='utf-8') as f:
                    accounts_data = json.load(f)
                    # â­ MIGRATION: Äáº£m báº£o má»—i tÃ i khoáº£n cÃ³ cÃ¡c trÆ°á»ng má»›i
                    updated = False
                    for account in accounts_data:
                        # Legacy field: proxy_status
                        if "proxy_status" not in account:
                            account["proxy_status"] = "ChÆ°a kiá»ƒm tra"
                            updated = True
                        # â­ NEW FIELD: permanent_proxy 
                        if "permanent_proxy" not in account:
                            account["permanent_proxy"] = ""
                            updated = True
                            print(f"[DEBUG] Migrated account {account.get('username', 'Unknown')} with permanent_proxy field")
                    
                    # LÆ°u láº¡i náº¿u cÃ³ migration
                    if updated:
                        print(f"[DEBUG] Migration completed for {len(accounts_data)} accounts")
                        # LÆ°u ngay láº­p tá»©c vá»›i data má»›i
                        try:
                            with open(self.accounts_file, 'w', encoding='utf-8') as f:
                                json.dump(accounts_data, f, indent=4, ensure_ascii=False)
                            print("[INFO] Migrated accounts data saved successfully.")
                        except Exception as e:
                            print(f"[ERROR] Failed to save migrated accounts: {e}")
                    
                    return accounts_data
            except json.JSONDecodeError:
                print("[ERROR] Lá»—i Ä‘á»c file accounts.json. File cÃ³ thá»ƒ bá»‹ há»ng.")
                return []
        return []

    def save_accounts(self):
        # Sá»­ dá»¥ng lock Ä‘á»ƒ trÃ¡nh race condition khi nhiá»u thread cÃ¹ng lÆ°u
        import threading
        if not hasattr(self, '_save_lock'):
            self._save_lock = threading.Lock()
            
        with self._save_lock:
            try:
                with open(self.accounts_file, 'w', encoding='utf-8') as f:
                    json.dump(self.accounts, f, indent=4, ensure_ascii=False)
                    print("[INFO] TÃ i khoáº£n Ä‘Ã£ Ä‘Æ°á»£c lÆ°u.")
            except Exception as e:
                print(f"[ERROR] Lá»—i khi lÆ°u accounts: {e}")

    def sync_proxy_data(self):
        """Äá»“ng bá»™ proxy data tá»« ProxyManagementTab"""
        try:
            print("[DEBUG] â­ Báº¯t Ä‘áº§u Ä‘á»“ng bá»™ proxy data tá»« ProxyManagementTab...")
            
            # Load proxy data tá»« proxy_status.json  
            proxy_file = 'proxy_status.json'
            if os.path.exists(proxy_file):
                with open(proxy_file, 'r', encoding='utf-8') as f:
                    proxy_data = json.load(f)
                
                print(f"[DEBUG] ÄÃ£ load {len(proxy_data)} proxy tá»« proxy_status.json")
                
                # Táº¡o mapping: assigned_account -> proxy
                proxy_assignments = {}
                available_proxies = []
                
                for proxy_info in proxy_data:
                    proxy_string = proxy_info.get('proxy', '')
                    assigned_account = proxy_info.get('assigned_account', '').strip()
                    proxy_status = proxy_info.get('status', '')
                    
                    if assigned_account:
                        # Proxy Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n cho tÃ i khoáº£n cá»¥ thá»ƒ
                        proxy_assignments[assigned_account] = {
                            'proxy': proxy_string,
                            'status': proxy_status
                        }
                        print(f"[DEBUG] Proxy assigned: {assigned_account} -> {proxy_string}")
                    elif proxy_status.lower() == 'ok':
                        # Proxy kháº£ dá»¥ng chÆ°a Ä‘Æ°á»£c gÃ¡n
                        available_proxies.append(proxy_string)
                
                print(f"[DEBUG] Found {len(proxy_assignments)} assigned proxies")
                print(f"[DEBUG] Found {len(available_proxies)} available proxies")
                
                # Cáº­p nháº­t proxy cho cÃ¡c tÃ i khoáº£n
                updated_count = 0
                auto_assigned_count = 0
                
                for account in self.accounts:
                    username = account.get('username', '')
                    current_proxy = account.get('proxy', '')
                    
                    # Kiá»ƒm tra xem cÃ³ proxy Ä‘Æ°á»£c gÃ¡n specifically cho tÃ i khoáº£n nÃ y khÃ´ng
                    if username in proxy_assignments:
                        new_proxy = proxy_assignments[username]['proxy']
                        proxy_status = proxy_assignments[username]['status']
                        
                        if current_proxy != new_proxy:
                            account['proxy'] = new_proxy
                            account['proxy_status'] = proxy_status
                            print(f"[INFO] âœ… Updated assigned proxy for {username}: {new_proxy}")
                            updated_count += 1
                    
                    # Náº¿u tÃ i khoáº£n chÆ°a cÃ³ proxy vÃ  cÃ³ proxy kháº£ dá»¥ng
                    elif not current_proxy and available_proxies:
                        new_proxy = available_proxies.pop(0)  # Láº¥y proxy Ä‘áº§u tiÃªn
                        account['proxy'] = new_proxy
                        account['proxy_status'] = 'OK'  # Assume OK since it's from available list
                        print(f"[INFO] ğŸ”„ Auto-assigned proxy for {username}: {new_proxy}")
                        auto_assigned_count += 1
                
                # LÆ°u thay Ä‘á»•i náº¿u cÃ³
                total_updates = updated_count + auto_assigned_count
                if total_updates > 0:
                    self.save_accounts()
                    self.update_account_table()
                    print(f"[SUCCESS] âœ… Proxy sync completed!")
                    print(f"  - Manual assignments updated: {updated_count}")
                    print(f"  - Auto assignments: {auto_assigned_count}")
                    print(f"  - Total accounts updated: {total_updates}")
                    
                    # Show success message
                    from PySide6.QtWidgets import QMessageBox
                    QMessageBox.information(
                        self, 
                        "Äá»“ng bá»™ Proxy", 
                        f"âœ… ÄÃ£ Ä‘á»“ng bá»™ proxy thÃ nh cÃ´ng!\n\n"
                        f"ğŸ“‹ Cáº­p nháº­t proxy Ä‘Ã£ gÃ¡n: {updated_count}\n"
                        f"ğŸ”„ Tá»± Ä‘á»™ng gÃ¡n proxy má»›i: {auto_assigned_count}\n"
                        f"ğŸ“Š Tá»•ng tÃ i khoáº£n Ä‘Æ°á»£c cáº­p nháº­t: {total_updates}"
                    )
                else:
                    print("[INFO] ğŸ’¡ No proxy updates needed - all accounts already have correct proxies")
                    
            else:
                print(f"[WARN] âš ï¸ KhÃ´ng tÃ¬m tháº¥y file {proxy_file}")
                from PySide6.QtWidgets import QMessageBox
                QMessageBox.warning(
                    self, 
                    "Äá»“ng bá»™ Proxy", 
                    f"âš ï¸ KhÃ´ng tÃ¬m tháº¥y file proxy_status.json\n\n"
                    f"Vui lÃ²ng import proxy tá»« tab 'Quáº£n lÃ½ Proxy' trÆ°á»›c!"
                )
                
        except Exception as e:
            print(f"[ERROR] âŒ Lá»—i khi Ä‘á»“ng bá»™ proxy data: {e}")
            import traceback
            traceback.print_exc()
            
            from PySide6.QtWidgets import QMessageBox
            QMessageBox.critical(
                self, 
                "Lá»—i Ä‘á»“ng bá»™ Proxy", 
                f"âŒ CÃ³ lá»—i xáº£y ra khi Ä‘á»“ng bá»™ proxy:\n\n{str(e)}"
            )

    def add_account(self):
        username, ok = QInputDialog.getText(self, "ThÃªm tÃ i khoáº£n", "TÃªn ngÆ°á»i dÃ¹ng:")
        if ok and username:
            password, ok = QInputDialog.getText(self, "ThÃªm tÃ i khoáº£n", "Máº­t kháº©u:", QLineEdit.Password)
            if ok:
                proxy, ok = QInputDialog.getText(self, "ThÃªm tÃ i khoáº£n", "Proxy (tÃ¹y chá»n):")
                if ok:
                    new_account = {
                        "selected": False,
                        "username": username,
                        "password": password,
                        "fullname": "",  # NEW: ThÃªm trÆ°á»ng Há» tÃªn
                        "proxy": proxy,
                        "status": "ChÆ°a Ä‘Äƒng nháº­p",
                        "gender": "-",  # ThÃªm cá»™t giá»›i tÃ­nh
                        "followers": "",
                        "following": "",
                        "last_action": "",  # ThÃªm cá»™t hÃ nh Ä‘á»™ng cuá»‘i
                        "proxy_status": "ChÆ°a kiá»ƒm tra",  # Khá»Ÿi táº¡o tráº¡ng thÃ¡i proxy
                        "permanent_proxy": ""  # â­ THÃŠM: Proxy vÄ©nh viá»…n cho tÃ i khoáº£n
                    }
                    self.accounts.append(new_account)
                    self.save_accounts()
                    self.update_account_table()

                    QMessageBox.information(self, "ThÃªm tÃ i khoáº£n", "TÃ i khoáº£n Ä‘Ã£ Ä‘Æ°á»£c thÃªm thÃ nh cÃ´ng.")

    @Slot()
    def update_account_table(self, accounts_to_display=None):
        if accounts_to_display is None:
            accounts_to_display = self.accounts

        self.account_table.blockSignals(True)  # Block signals to prevent itemChanged from firing
        self.account_table.setRowCount(len(accounts_to_display))
        for row_idx, account in enumerate(accounts_to_display):
            # Cá»™t "Chá»n" - KHÃ”NG setFlags kiá»ƒu checkbox ná»¯a, chá»‰ Ä‘á»ƒ delegate váº½
            item_checkbox = QTableWidgetItem()
            item_checkbox.setData(CheckboxDelegate.CheckboxStateRole, account.get("selected", False))
            self.account_table.setItem(row_idx, 0, item_checkbox)  # Thiáº¿t láº­p item cho cá»™t 0

            # STT
            stt_item = QTableWidgetItem(str(row_idx + 1))
            stt_item.setTextAlignment(Qt.AlignCenter)
            self.account_table.setItem(row_idx, 1, stt_item)

            # TÃªn Ä‘Äƒng nháº­p
            username_item = QTableWidgetItem(account.get("username", ""))
            username_item.setTextAlignment(Qt.AlignLeft | Qt.AlignVCenter)
            self.account_table.setItem(row_idx, 2, username_item)

            # Máº­t kháº©u
            password_item = QTableWidgetItem(account.get("password", ""))
            password_item.setTextAlignment(Qt.AlignLeft | Qt.AlignVCenter)
            self.account_table.setItem(row_idx, 3, password_item)

            # Tráº¡ng thÃ¡i
            status_item = QTableWidgetItem(account.get("status", "ChÆ°a Ä‘Äƒng nháº­p"))
            status_item.setTextAlignment(Qt.AlignCenter)
            if account.get("status") == "ÄÄƒng nháº­p tháº¥t báº¡i":
                status_item.setForeground(QColor("red"))
            elif account.get("status") == "ÄÃ£ Ä‘Äƒng nháº­p" or account.get("status") == "Live":
                status_item.setForeground(QColor("green"))
            elif account.get("status") == "Die":
                status_item.setForeground(QColor("red"))  # ThÃªm mÃ u Ä‘á» cho tráº¡ng thÃ¡i "Die"
            else:
                status_item.setForeground(QColor("black"))  # Máº·c Ä‘á»‹nh mÃ u Ä‘en
            self.account_table.setItem(row_idx, 4, status_item)

            # Proxy
            proxy_item = QTableWidgetItem(account.get("proxy", ""))
            proxy_item.setTextAlignment(Qt.AlignLeft | Qt.AlignVCenter)
            self.account_table.setItem(row_idx, 5, proxy_item)

            # â­ PERMANENT PROXY - Cá»™t má»›i
            permanent_proxy_item = QTableWidgetItem(account.get("permanent_proxy", ""))
            permanent_proxy_item.setTextAlignment(Qt.AlignLeft | Qt.AlignVCenter)
            # ÄÃ¡nh dáº¥u permanent proxy báº±ng mÃ u xanh
            if account.get("permanent_proxy", "").strip():
                permanent_proxy_item.setForeground(QColor("blue"))
                permanent_proxy_item.setToolTip("Proxy vÄ©nh viá»…n - Æ°u tiÃªn sá»­ dá»¥ng")
            else:
                permanent_proxy_item.setForeground(QColor("gray"))
                permanent_proxy_item.setToolTip("ChÆ°a cÃ³ proxy vÄ©nh viá»…n")
            self.account_table.setItem(row_idx, 6, permanent_proxy_item)

            # Tráº¡ng thÃ¡i Proxy
            proxy_status_item = QTableWidgetItem(account.get("proxy_status", "ChÆ°a kiá»ƒm tra"))
            proxy_status_item.setTextAlignment(Qt.AlignCenter)
            if account.get("proxy_status") == "Die":
                proxy_status_item.setForeground(QColor("red"))
            elif account.get("proxy_status") == "OK":
                proxy_status_item.setForeground(QColor("green"))
            else:
                proxy_status_item.setForeground(QColor("black"))
            self.account_table.setItem(row_idx, 7, proxy_status_item)

            # Follower
            follower_item = QTableWidgetItem(account.get("followers", ""))
            follower_item.setTextAlignment(Qt.AlignCenter)
            self.account_table.setItem(row_idx, 8, follower_item)

            # Following
            following_item = QTableWidgetItem(account.get("following", ""))
            following_item.setTextAlignment(Qt.AlignCenter)
            self.account_table.setItem(row_idx, 9, following_item)

            # HÃ nh Ä‘á»™ng cuá»‘i
            last_action_item = QTableWidgetItem(account.get("last_action", ""))
            last_action_item.setTextAlignment(Qt.AlignLeft | Qt.AlignVCenter)
            self.account_table.setItem(row_idx, 10, last_action_item)
        self.account_table.blockSignals(False)  # Unblock signals
        self.update_stats(accounts_to_display)

    @Slot()
    def update_stats(self, accounts_to_display=None):
        if accounts_to_display is None:
            accounts_to_display = self.accounts
        total = len(accounts_to_display)
        live = 0
        die = 0
        selected = 0
        for acc in accounts_to_display:
            status = str(acc.get("status", "")).lower()
            if status == "live":
                live += 1
            elif status == "die":
                die += 1
            if acc.get("selected", False):
                selected += 1
        not_selected = total - selected
        stats_html = (
            f'<span style="color:black">Tá»•ng: <b>{total}</b></span> | '
            f'<span style="color:green">Live: <b>{live}</b></span> | '
            f'<span style="color:red">Die: <b>{die}</b></span> | '
            f'<span style="color:#1976D2">ÄÃ£ chá»n: <b>{selected}</b></span> | '
            f'<span style="color:gray">ChÆ°a chá»n: <b>{not_selected}</b></span>'
        )
        self.stats_label.setText(stats_html)

    def on_checkbox_clicked(self, row, new_state):
        # HÃ m nÃ y Ä‘Æ°á»£c káº¿t ná»‘i tá»« delegate Ä‘á»ƒ xá»­ lÃ½ khi tráº¡ng thÃ¡i checkbox thay Ä‘á»•i
        if row < len(self.accounts):
            self.accounts[row]["selected"] = new_state
            self.save_accounts()
            print(f"[DEBUG] Checkbox táº¡i hÃ ng {row} Ä‘Æ°á»£c chuyá»ƒn thÃ nh: {new_state}. TÃ i khoáº£n: {self.accounts[row]['username']}")
        self.update_stats()

    def handle_item_changed(self, item):
        # Kiá»ƒm tra náº¿u tÃ­n hiá»‡u bá»‹ block, bá» qua
        if self.account_table.signalsBlocked():
            return

        row = item.row()
        col = item.column()

        if col == 0:  # Cá»™t checkbox, Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi on_checkbox_clicked
            return

        # Chá»‰ xá»­ lÃ½ cÃ¡c cá»™t cÃ³ thá»ƒ chá»‰nh sá»­a: TÃªn Ä‘Äƒng nháº­p, Máº­t kháº©u, Proxy, Permanent Proxy
        if col == 2:  # TÃªn Ä‘Äƒng nháº­p
            self.accounts[row]["username"] = item.text()
        elif col == 3:  # Máº­t kháº©u
            self.accounts[row]["password"] = item.text()
        elif col == 5:  # Proxy
            self.accounts[row]["proxy"] = item.text()
        elif col == 6:  # â­ Permanent Proxy
            self.accounts[row]["permanent_proxy"] = item.text()
            print(f"[DEBUG] Cáº­p nháº­t permanent proxy cho {self.accounts[row]['username']}: {item.text()}")
        else:
            return  # KhÃ´ng xá»­ lÃ½ cÃ¡c cá»™t khÃ¡c

        self.save_accounts()
        self.update_stats()

    def filter_accounts(self, text):
        filtered_accounts = [
            account for account in self.accounts
            if text.lower() in account.get("username", "").lower() or
            text.lower() in account.get("status", "").lower() or
            text.lower() in account.get("proxy", "").lower() or
            text.lower() in account.get("permanent_proxy", "").lower() or  # â­ ThÃªm permanent proxy vÃ o search
            text.lower() in account.get("proxy_status", "").lower() or
            text.lower() in account.get("last_action", "").lower()
        ]
        if self.category_combo.currentText() != "Táº¥t cáº£":
            folder_name = self.category_combo.currentText()
            # Äáº£m báº£o ráº±ng get() cÃ³ má»™t giÃ¡ trá»‹ máº·c Ä‘á»‹nh cho trÆ°á»ng há»£p username khÃ´ng cÃ³ trong folder_map
            filtered_accounts = [acc for acc in filtered_accounts if self.folder_map.get(acc.get("username"), "Tá»•ng") == folder_name]

        self.update_account_table(filtered_accounts)
        self.update_stats(filtered_accounts)

    def get_window_positions(self, num_windows):
        # KÃ­ch thÆ°á»›c má»—i cá»­a sá»• theo yÃªu cáº§u
        win_w, win_h = 450, 380
        
        # Láº¥y kÃ­ch thÆ°á»›c mÃ n hÃ¬nh
        try:
            from PySide6.QtGui import QGuiApplication
            screen = QGuiApplication.primaryScreen()
            geometry = screen.geometry()
            screen_w, screen_h = geometry.width(), geometry.height()
            print(f"[DEBUG] KÃ­ch thÆ°á»›c mÃ n hÃ¬nh: {screen_w}x{screen_h}")
        except Exception:
            screen_w, screen_h = 1920, 1080  # fallback náº¿u khÃ´ng láº¥y Ä‘Æ°á»£c
        
        # TÃ­nh toÃ¡n lÆ°á»›i xáº¿p cá»­a sá»•
        margin = 10  # Khoáº£ng cÃ¡ch nhá» giá»¯a cÃ¡c cá»­a sá»•
        effective_win_w = win_w + margin
        effective_win_h = win_h + margin
        
        # Sá»‘ cá»™t tá»‘i Ä‘a cÃ³ thá»ƒ xáº¿p trÃªn mÃ n hÃ¬nh
        max_cols = max(1, (screen_w - margin) // effective_win_w)
        print(f"[DEBUG] Sá»‘ cá»™t tá»‘i Ä‘a: {max_cols}")
        
        positions = []
        for i in range(num_windows):
            # TÃ­nh vá»‹ trÃ­ trong lÆ°á»›i: tá»« trÃ¡i sang pháº£i, tá»« trÃªn xuá»‘ng dÆ°á»›i
            col = i % max_cols
            row = i // max_cols
            
            # TÃ­nh toÃ¡n vá»‹ trÃ­ pixel
            x = margin + col * effective_win_w
            y = margin + row * effective_win_h
            
            # Äáº£m báº£o khÃ´ng vÆ°á»£t quÃ¡ mÃ n hÃ¬nh
            if x + win_w > screen_w:
                x = screen_w - win_w - margin
            if y + win_h > screen_h:
                y = screen_h - win_h - margin
            
            positions.append((x, y, win_w, win_h))
            print(f"[DEBUG] Cá»­a sá»• {i+1}: HÃ ng {row+1}, Cá»™t {col+1} â†’ Vá»‹ trÃ­ ({x}, {y})")
        
        return positions

    def login_selected_accounts(self):
        # Cháº¡y Ä‘Äƒng nháº­p cho tá»«ng tÃ i khoáº£n trong thread phá»¥, khÃ´ng block main thread
        import threading
        selected_accounts = [acc for acc in self.accounts if acc.get('selected')]
        if not selected_accounts:
            QMessageBox.information(self, "ThÃ´ng bÃ¡o", "Vui lÃ²ng chá»n Ã­t nháº¥t 1 tÃ i khoáº£n Ä‘á»ƒ Ä‘Äƒng nháº­p.")
            return
        def login_worker(account, window_position=None):
            import threading
            username = account.get('username', 'Unknown')
            thread_id = threading.get_ident()
            
            print(f"[DEBUG] Thread worker Báº®T Äáº¦U cho {username} - thread id: {thread_id}")
            
            # Signal bÃ¡o thread báº¯t Ä‘áº§u
            try:
                account["status"] = "Thread báº¯t Ä‘áº§u..."
                self.status_updated.emit(username, account["status"])
                print(f"[DEBUG] ÄÃ£ emit signal báº¯t Ä‘áº§u cho {username}")
            except Exception as e:
                print(f"[ERROR] KhÃ´ng thá»ƒ emit signal báº¯t Ä‘áº§u cho {username}: {e}")
            
            # Wrapping toÃ n bá»™ logic trong try-catch Ä‘á»ƒ Ä‘áº£m báº£o luÃ´n emit signal
            try:
                print(f"[DEBUG] Gá»i login_instagram_and_get_info cho {username}")
                result = self.login_instagram_and_get_info(account, window_position)
                print(f"[DEBUG] login_instagram_and_get_info hoÃ n thÃ nh cho {username} vá»›i result: {result}")
                return result
                
            except Exception as e:
                print(f"[CRITICAL][Thread] Lá»—i nghiÃªm trá»ng trong thread {username}: {type(e).__name__}: {e}")
                import traceback
                traceback.print_exc()
                
                # Äáº£m báº£o luÃ´n emit signal cáº­p nháº­t tráº¡ng thÃ¡i
                try:
                    error_status = f"Lá»—i thread: {type(e).__name__}"
                    account["status"] = error_status
                    self.status_updated.emit(username, error_status)
                    print(f"[DEBUG] ÄÃ£ emit signal lá»—i nghiÃªm trá»ng cho {username}")
                except Exception as emit_error:
                    print(f"[CRITICAL] KhÃ´ng thá»ƒ emit signal cuá»‘i cÃ¹ng cho {username}: {emit_error}")
                
                return "Lá»—i thread", "Lá»—i", None
                
            finally:
                print(f"[DEBUG] Thread worker Káº¾T THÃšC cho {username}")
                
        window_positions = self.get_window_positions(len(selected_accounts))
        
        # âš¡ Tá»I Æ¯U: Khá»Ÿi Ä‘á»™ng threads nhanh hÆ¡n
        for idx, account in enumerate(selected_accounts):
            pos = window_positions[idx] if window_positions else None
            t = threading.Thread(target=login_worker, args=(account, pos), daemon=True)
            t.start()
            # âš¡ Giáº£m delay Ä‘á»ƒ khá»Ÿi Ä‘á»™ng nhanh hÆ¡n
            if idx < len(selected_accounts) - 1:
                time.sleep(0.2)  # âš¡ Giáº£m tá»« 0.5s xuá»‘ng 0.2s

    def login_instagram_and_get_info(self, account, window_position=None, max_retries=3, retry_delay=5):
        """ÄÄƒng nháº­p Instagram theo logic yÃªu cáº§u cá»§a user"""
        driver = None
        username = account.get("username")
        password = account.get("password")
        # â­ PROXY LOGIC Tá»I Æ¯U: Æ¯u tiÃªn permanent_proxy trÆ°á»›c
        if getattr(self, 'use_proxy', True):
            # Kiá»ƒm tra permanent_proxy trÆ°á»›c
            permanent_proxy = account.get("permanent_proxy", "").strip()
            if permanent_proxy:
                proxy = permanent_proxy
                print(f"[DEBUG] Sá»­ dá»¥ng permanent proxy cho {username}: {permanent_proxy}")
            else:
                # Fallback sang proxy thÆ°á»ng
                proxy = account.get("proxy", "").strip()
                if proxy:
                    print(f"[DEBUG] Sá»­ dá»¥ng proxy thÆ°á»ng cho {username}: {proxy}")
                else:
                    proxy = None
                    print(f"[DEBUG] KhÃ´ng cÃ³ proxy cho {username}")
        else:
            proxy = None
            print(f"[DEBUG] Proxy bá»‹ táº¯t - khÃ´ng sá»­ dá»¥ng proxy cho {username}")
        
        print(f"[INFO] ===== Báº®T Äáº¦U ÄÄ‚NG NHáº¬P: {username} =====")
        print(f"[DEBUG] Account object username: {username}, account id: {id(account)}")
        
        try:
            # BÆ¯á»šC 1: Má» CHROME DRIVER TIáº¾N HÃ€NH ÄÄ‚NG NHáº¬P
            print(f"[1] Má»Ÿ Chrome driver cho {username}")
            account["status"] = "Äang má»Ÿ Chrome driver..."
            self.status_updated.emit(username, "Äang má»Ÿ Chrome driver...")
            
            driver = self.init_driver(proxy, username=username)
            
            # Äáº·t vá»‹ trÃ­ cá»­a sá»• ngay sau khi táº¡o Ä‘á»ƒ trÃ¡nh Ä‘Ã¨ lÃªn nhau
            if window_position and len(window_position) == 4:
                x, y, width, height = window_position
                print(f"[DEBUG] Äáº·t vá»‹ trÃ­ cá»­a sá»• cho {username}: ({x}, {y}) size ({width}, {height})")
                try:
                    driver.set_window_rect(x, y, width, height)
                    time.sleep(0.3)  # Chá» cá»­a sá»• á»•n Ä‘á»‹nh
                except Exception as e:
                    print(f"[WARN] KhÃ´ng thá»ƒ Ä‘áº·t vá»‹ trÃ­ cá»­a sá»•: {e}")
            else:
                # Vá»‹ trÃ­ máº·c Ä‘á»‹nh náº¿u khÃ´ng cÃ³ window_position
                try:
                    driver.set_window_rect(100, 100, 450, 380)
                except Exception as e:
                    print(f"[WARN] KhÃ´ng thá»ƒ Ä‘áº·t vá»‹ trÃ­ máº·c Ä‘á»‹nh: {e}")
            
            # âš¡ Tá»I Æ¯U: Truy cáº­p Instagram nhanh hÆ¡n
            print(f"[DEBUG] Truy cáº­p Instagram cho {username}")
            driver.get("https://www.instagram.com/")
            time.sleep(1)  # âš¡ Giáº£m tá»« 3s xuá»‘ng 1s
            
            # â­ KIá»‚M TRA TÃ€I KHOáº¢N Bá»Š KHÃ“A NGAY KHI TRUY Cáº¬P INSTAGRAM
            print(f"[DEBUG] ===== KIá»‚M TRA TÃ€I KHOáº¢N Bá»Š KHÃ“A KHI TRUY Cáº¬P CHO {username} =====")
            
            # Kiá»ƒm tra yÃªu cáº§u xÃ¡c minh danh tÃ­nh trÆ°á»›c (khÃ´ng pháº£i tÃ i khoáº£n bá»‹ khÃ³a)
            if self.check_identity_verification_required(driver):
                print(f"[WARN] ğŸ” TÃ€I KHOáº¢N {username} Cáº¦N XÃC MINH DANH TÃNH - KhÃ´ng pháº£i bá»‹ khÃ³a")
                account["status"] = "Cáº§n xÃ¡c minh danh tÃ­nh"
                account["last_action"] = f"YÃªu cáº§u xÃ¡c minh danh tÃ­nh lÃºc {time.strftime('%H:%M:%S')}"
                self.status_updated.emit(username, account["status"])
                
                # Giá»¯ trÃ¬nh duyá»‡t má»Ÿ Ä‘á»ƒ user cÃ³ thá»ƒ xÃ¡c minh thá»§ cÃ´ng náº¿u cáº§n
                continue_result = self.show_captcha_dialog_safe(driver, username, "identity_verification")
                if continue_result:
                    # User Ä‘Ã£ xá»­ lÃ½ xong, kiá»ƒm tra láº¡i
                    if self.check_home_and_explore_icons(driver):
                        print(f"[SUCCESS] âœ… ÄÃ£ xÃ¡c minh danh tÃ­nh thÃ nh cÃ´ng: {username}")
                        self.save_cookies(driver, username)
                        account["status"] = "ÄÃ£ Ä‘Äƒng nháº­p"
                        self.status_updated.emit(username, account["status"])
                        self.close_browser_safely(driver, username)
                        return "ÄÃ£ Ä‘Äƒng nháº­p", "OK", None
                else:
                    self.close_browser_safely(driver, username)
                    return "ÄÃ£ bá» qua", "Bá» qua", None
            
            # Kiá»ƒm tra tÃ i khoáº£n tháº­t sá»± bá»‹ khÃ³a
            elif self.check_account_locked(driver):
                print(f"[ERROR] âŒ TÃ€I KHOáº¢N {username} Bá»Š KHÃ“A - PhÃ¡t hiá»‡n ngay khi truy cáº­p Instagram")
                account["status"] = "TÃ i khoáº£n Die - Automated Behavior"
                account["last_action"] = f"PhÃ¡t hiá»‡n tÃ i khoáº£n bá»‹ khÃ³a khi truy cáº­p lÃºc {time.strftime('%H:%M:%S')}"
                self.status_updated.emit(username, account["status"])
                
                # ÄÃ³ng trÃ¬nh duyá»‡t vÃ  tráº£ vá» káº¿t quáº£
                try:
                    self.close_browser_safely(driver, username)
                except Exception as e:
                    print(f"[WARN] Lá»—i khi Ä‘Ã³ng browser: {e}")
                
                print(f"[INFO] ===== HOÃ€N Táº¤T: {username} (ACCOUNT LOCKED ON ACCESS) =====")
                return "TÃ i khoáº£n Die", "Die", None
            
            # BÆ¯á»šC 2: LOAD SESSION COOKIES
            print(f"[2] Load session cookies cho {username}")
            account["status"] = "Äang load session cookies..."
            self.status_updated.emit(username, "Äang load session cookies...")
            
            cookies_loaded = self.load_cookies(driver, username)
            print(f"[DEBUG] Káº¿t quáº£ load cookies cho {username}: {cookies_loaded}")
            
            if cookies_loaded:
                print(f"[DEBUG] ÄÃ£ load cookies cho {username} - Refresh trang...")
                driver.refresh()
                time.sleep(1.5)  # âš¡ Giáº£m tá»« 3s xuá»‘ng 1.5s
                print(f"[DEBUG] Sau refresh - URL: {driver.current_url}")
                
                # â­ QUAN TRá»ŒNG: KIá»‚M TRA TÃ€I KHOáº¢N SAU KHI LOAD COOKIES
                print(f"[DEBUG] ===== KIá»‚M TRA TÃ€I KHOáº¢N SAU LOAD COOKIES CHO {username} =====")
                
                # Kiá»ƒm tra yÃªu cáº§u xÃ¡c minh danh tÃ­nh trÆ°á»›c
                if self.check_identity_verification_required(driver):
                    print(f"[WARN] ğŸ” TÃ€I KHOáº¢N {username} Cáº¦N XÃC MINH DANH TÃNH sau load cookies")
                    account["status"] = "Cáº§n xÃ¡c minh danh tÃ­nh"
                    self.status_updated.emit(username, account["status"])
                    continue_result = self.show_captcha_dialog_safe(driver, username, "identity_verification")
                    if continue_result and self.check_home_and_explore_icons(driver):
                        print(f"[SUCCESS] âœ… ÄÃ£ xÃ¡c minh danh tÃ­nh thÃ nh cÃ´ng: {username}")
                        self.save_cookies(driver, username)
                        account["status"] = "ÄÃ£ Ä‘Äƒng nháº­p"
                        self.status_updated.emit(username, account["status"])
                        self.close_browser_safely(driver, username)
                        return "ÄÃ£ Ä‘Äƒng nháº­p", "OK", None
                    else:
                        self.close_browser_safely(driver, username)
                        return "ÄÃ£ bá» qua", "Bá» qua", None
                
                # Kiá»ƒm tra tÃ i khoáº£n tháº­t sá»± bá»‹ khÃ³a
                elif self.check_account_locked(driver):
                    print(f"[ERROR] âŒ TÃ€I KHOáº¢N {username} Bá»Š KHÃ“A - PhÃ¡t hiá»‡n ngay sau load cookies")
                    account["status"] = "TÃ i khoáº£n Die - Automated Behavior"
                    account["last_action"] = f"PhÃ¡t hiá»‡n tÃ i khoáº£n bá»‹ khÃ³a lÃºc {time.strftime('%H:%M:%S')}"
                    self.status_updated.emit(username, account["status"])
                    
                    # ÄÃ³ng trÃ¬nh duyá»‡t vÃ  tráº£ vá» káº¿t quáº£
                    try:
                        self.close_browser_safely(driver, username)
                    except Exception as e:
                        print(f"[WARN] Lá»—i khi Ä‘Ã³ng browser: {e}")
                    
                    print(f"[INFO] ===== HOÃ€N Táº¤T: {username} (ACCOUNT LOCKED) =====")
                    return "TÃ i khoáº£n Die", "Die", None
                
                # Debug DOM trÆ°á»›c khi kiá»ƒm tra session
                print(f"[DEBUG] ===== KIá»‚M TRA SESSION Báº°NG COOKIES CHO {username} =====")
                self.debug_instagram_dom(driver, username)
                
                # Kiá»ƒm tra session cÃ²n háº¡n khÃ´ng báº±ng cÃ¡ch check 2 icon
                print(f"[DEBUG] Gá»i check_home_and_explore_icons Ä‘á»ƒ kiá»ƒm tra session cho {username}")
                session_valid = self.check_home_and_explore_icons(driver)
                print(f"[DEBUG] Káº¿t quáº£ kiá»ƒm tra session: {session_valid}")
                
                if session_valid:
                    print(f"[SUCCESS] âœ… Session cÃ²n háº¡n - ÄÄƒng nháº­p thÃ nh cÃ´ng báº±ng cookies: {username}")
                    
                    # â­ Tá»I Æ¯U: Real-time status update ngay láº­p tá»©c
                    account["status"] = "âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng"
                    account["last_action"] = f"ÄÄƒng nháº­p cookies lÃºc {time.strftime('%H:%M:%S')}"
                    
                    # Emit signal vá»›i Ä‘á»“ng bá»™ hÃ³a tá»‘t hÆ¡n
                    self.status_updated.emit(username, account["status"])
                    
                    # â­ Tá»I Æ¯U: Xá»­ lÃ½ song song - lÆ°u cookies trong khi cáº­p nháº­t UI
                    from concurrent.futures import ThreadPoolExecutor
                    import threading
                    
                    # Thread cho viá»‡c lÆ°u cookies (khÃ´ng block UI)
                    def save_cookies_async():
                        try:
                            self.save_cookies(driver, username)
                            print(f"[INFO] âœ… ÄÃ£ lÆ°u cookies cho {username}")
                        except Exception as e:
                            print(f"[WARN] Lá»—i khi lÆ°u cookies: {e}")
                    
                    # Báº¯t Ä‘áº§u lÆ°u cookies trong background
                    threading.Thread(target=save_cookies_async, daemon=True).start()
                    
                    # â­ Tá»I Æ¯U: Force UI update ngay láº­p tá»©c
                    from PySide6.QtCore import QCoreApplication
                    QCoreApplication.processEvents()
                    
                    # â­ Tá»I Æ¯U: Visual feedback tá»‘t hÆ¡n - khÃ´ng cáº§n delay dÃ i
                    account["status"] = "ğŸ”„ HoÃ n táº¥t Ä‘Äƒng nháº­p..."
                    self.status_updated.emit(username, account["status"])
                    QCoreApplication.processEvents()
                    time.sleep(0.5)  # Giáº£m tá»« 1.5s xuá»‘ng 0.5s
                    
                    # â­ Tá»I Æ¯U: ÄÃ³ng browser an toÃ n hÆ¡n
                    self.close_browser_safely(driver, username)
                    
                    # Final status update
                    account["status"] = "ÄÃ£ Ä‘Äƒng nháº­p"
                    self.status_updated.emit(username, account["status"])
                    QCoreApplication.processEvents()
                    
                    print(f"[INFO] ===== HOÃ€N Táº¤T: {username} =====")
                    return "ÄÃ£ Ä‘Äƒng nháº­p", "OK", None
                else:
                    print(f"[WARN] Session quÃ¡ háº¡n cho {username} - Cáº§n Ä‘Äƒng nháº­p láº¡i")
                    print(f"[DEBUG] URL hiá»‡n táº¡i: {driver.current_url}")
                    try:
                        title = driver.title
                        print(f"[DEBUG] Title hiá»‡n táº¡i: {title}")
                    except Exception as e:
                        print(f"[DEBUG] Lá»—i khi láº¥y title: {e}")
                    
                    # Kiá»ƒm tra xem cÃ³ pháº£i Ä‘ang á»Ÿ trang login khÃ´ng
                    if "login" in driver.current_url.lower() or "accounts/login" in driver.current_url.lower():
                        print(f"[DEBUG] Äang á»Ÿ trang login - session tháº­t sá»± háº¿t háº¡n")
                    else:
                        print(f"[DEBUG] KhÃ´ng á»Ÿ trang login - cÃ³ thá»ƒ váº«n Ä‘ang load hoáº·c cÃ³ lá»—i khÃ¡c")
                        
                        # Kiá»ƒm tra xem cÃ³ pháº£i bá»‹ captcha/checkpoint khÃ´ng
                        if self.check_captcha_required(driver):
                            print(f"[WARN] âš ï¸ PhÃ¡t hiá»‡n captcha khi load cookies cho {username}")
                            account["status"] = "Checkpoint/Captcha: Cáº§n thao tÃ¡c thá»§ cÃ´ng"
                            self.status_updated.emit(username, account["status"])
                            # Giá»¯ cá»­a sá»• má»Ÿ Ä‘á»ƒ user xá»­ lÃ½
                            continue_result = self.show_captcha_dialog_safe(driver, username, "captcha")
                            if continue_result:
                                # Sau khi user xá»­ lÃ½, check láº¡i
                                if self.check_home_and_explore_icons(driver):
                                    print(f"[SUCCESS] âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng sau xá»­ lÃ½ captcha: {username}")
                                    self.save_cookies(driver, username)
                                    account["status"] = "ÄÃ£ Ä‘Äƒng nháº­p"
                                    self.status_updated.emit(username, account["status"])
                                    driver.quit()
                                    return "ÄÃ£ Ä‘Äƒng nháº­p", "OK", None
                            else:
                                driver.quit()
                                return "ÄÃ£ bá» qua", "Bá» qua", None
            else:
                print(f"[DEBUG] KhÃ´ng cÃ³ cookies hoáº·c khÃ´ng load Ä‘Æ°á»£c cookies cho {username}")
            
            # BÆ¯á»šC 3: SESSION QUÃ Háº N - YÃŠU Cáº¦U NHáº¬P TÃ€I KHOáº¢N Máº¬T KHáº¨U
            print(f"[3] Session quÃ¡ háº¡n - Nháº­p tÃ i khoáº£n máº­t kháº©u cho {username}")
            account["status"] = "Session quÃ¡ háº¡n - Äang nháº­p tÃ i khoáº£n máº­t kháº©u..."
            self.status_updated.emit(username, account["status"])
            
            # âš¡ Tá»I Æ¯U: Nháº­p thÃ´ng tin Ä‘Äƒng nháº­p nhanh hÆ¡n
            try:
                username_input = driver.find_element(By.NAME, "username")
                username_input.clear()
                username_input.send_keys(username)
                time.sleep(0.3)  # âš¡ Giáº£m tá»« 1s xuá»‘ng 0.3s
                
                # TÃ¬m vÃ  nháº­p password  
                password_input = driver.find_element(By.NAME, "password")
                password_input.clear()
                password_input.send_keys(password)
                time.sleep(0.3)  # âš¡ Giáº£m tá»« 1s xuá»‘ng 0.3s
                
                # Nháº¥n Enter Ä‘á»ƒ Ä‘Äƒng nháº­p
                password_input.send_keys(Keys.ENTER)
                print(f"[DEBUG] ÄÃ£ gá»­i thÃ´ng tin Ä‘Äƒng nháº­p cho {username}")
                
            except Exception as e:
                print(f"[ERROR] KhÃ´ng thá»ƒ nháº­p thÃ´ng tin Ä‘Äƒng nháº­p: {e}")
                account["status"] = "Lá»—i nháº­p thÃ´ng tin Ä‘Äƒng nháº­p"
                self.status_updated.emit(username, account["status"])
                driver.quit()
                return "Lá»—i nháº­p thÃ´ng tin", "Lá»—i", None
            
            # BÆ¯á»šC 4: SAU KHI ÄÄ‚NG NHáº¬P - CHECK THEO LOGIC YÃŠU Cáº¦U - Tá»I Æ¯U Má»šI
            print(f"[4] âš¡ Kiá»ƒm tra káº¿t quáº£ Ä‘Äƒng nháº­p tá»‘i Æ°u cho {username}")
            account["status"] = "Äang kiá»ƒm tra káº¿t quáº£ Ä‘Äƒng nháº­p..."
            self.status_updated.emit(username, account["status"])
            
            # âš¡ Tá»I Æ¯U: TÄƒng thá»i gian chá» cho 2FA vÃ  cÃ¡c trÆ°á»ng há»£p Ä‘áº·c biá»‡t
            max_wait_time = 15  # âš¡ TÄƒng tá»« 10s lÃªn 15s Ä‘á»ƒ cÃ³ thá»i gian xá»­ lÃ½ 2FA
            check_interval = 0.8  # âš¡ Giáº£m tá»« 1.0s xuá»‘ng 0.8s Ä‘á»ƒ check nhanh hÆ¡n
            start_time = time.time()
            
            print(f"[DEBUG] ===== Báº®T Äáº¦U VÃ’NG Láº¶P KIá»‚M TRA CHO {username} =====")
            
            while time.time() - start_time < max_wait_time:
                try:
                    elapsed_time = time.time() - start_time
                    print(f"[DEBUG] VÃ²ng láº·p kiá»ƒm tra - Thá»i gian Ä‘Ã£ trÃ´i qua: {elapsed_time:.1f}s/{max_wait_time}s")
                    
                    time.sleep(check_interval)
                    
                    print(f"[DEBUG] Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Äƒng nháº­p cho {username} - URL: {driver.current_url}")
                    
                    # â­ KIá»‚M TRA Æ¯U TIÃŠN: 2FA TRÆ¯á»šC TIÃŠN - TRÃNH Bá»Š ÄÆ 
                    print(f"[DEBUG] ğŸ”¥ KIá»‚M TRA 2FA Æ¯U TIÃŠN cho {username}")
                    if self.check_2fa_required(driver):
                        print(f"[SUCCESS] âš ï¸ PHÃT HIá»†N 2FA NGAY Láº¬P Tá»¨C cho {username}")
                        account["status"] = "âš ï¸ PhÃ¡t hiá»‡n yÃªu cáº§u nháº­p 2FA"
                        self.status_updated.emit(username, account["status"])
                        
                        # âš¡ NGAY Láº¬P Tá»¨C: Hiá»ƒn thá»‹ dialog Ä‘á»ƒ user xá»­ lÃ½ 2FA
                        continue_result = self.show_captcha_dialog_safe(driver, username, "2fa")
                        if continue_result:
                            print(f"[DEBUG] User Ä‘Ã£ nháº­p 2FA vÃ  nháº¥n tiáº¿p tá»¥c")
                            
                            # âš¡ CHá»œ THÃŠM THá»œI GIAN CHO 2FA Xá»¬ LÃ
                            print(f"[DEBUG] Chá» 2FA Ä‘Æ°á»£c xá»­ lÃ½...")
                            time.sleep(3)  # Chá» 3 giÃ¢y Ä‘á»ƒ 2FA Ä‘Æ°á»£c xá»­ lÃ½
                            
                            # Kiá»ƒm tra láº¡i Ä‘Äƒng nháº­p thÃ nh cÃ´ng
                            if self.check_home_and_explore_icons(driver):
                                print(f"[SUCCESS] âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng sau nháº­p 2FA: {username}")
                                
                                # â­ SUCCESS HANDLING
                                account["status"] = "ğŸ‰ ÄÃ£ vÆ°á»£t qua 2FA - ÄÄƒng nháº­p thÃ nh cÃ´ng!"
                                account["last_action"] = f"VÆ°á»£t 2FA + Ä‘Äƒng nháº­p lÃºc {time.strftime('%H:%M:%S')}"
                                self.status_updated.emit(username, account["status"])
                                
                                # Background processing
                                from PySide6.QtCore import QCoreApplication
                                import threading
                                QCoreApplication.processEvents()
                                
                                def save_and_cleanup():
                                    try:
                                        self.save_cookies(driver, username)
                                        account["status"] = "ÄÃ£ Ä‘Äƒng nháº­p"
                                        self.status_updated.emit(username, account["status"])
                                    except Exception as e:
                                        print(f"[WARN] Lá»—i khi lÆ°u cookies: {e}")
                                    finally:
                                        self.close_browser_safely(driver, username)
                                
                                threading.Thread(target=save_and_cleanup, daemon=True).start()
                                print(f"[INFO] ===== HOÃ€N Táº¤T 2FA: {username} =====")
                                return "ÄÃ£ Ä‘Äƒng nháº­p", "OK", None
                            else:
                                print(f"[WARN] 2FA Ä‘Ã£ nháº­p nhÆ°ng chÆ°a tháº¥y icons, tiáº¿p tá»¥c chá»...")
                                # Tiáº¿p tá»¥c vÃ²ng láº·p Ä‘á»ƒ chá» thÃªm
                                continue
                        else:
                            print(f"[INFO] User chá»n bá» qua 2FA")
                            account["status"] = "ÄÃ£ bá» qua 2FA"
                            self.status_updated.emit(username, account["status"])
                            driver.quit()
                            return "ÄÃ£ bá» qua", "Bá» qua", None
                    
                    # â­ KIá»‚M TRA Æ¯U TIÃŠN THá»¨ 2: CAPTCHA
                    print(f"[DEBUG] ğŸ”’ KIá»‚M TRA CAPTCHA cho {username}")
                    if self.check_captcha_required(driver):
                        print(f"[WARN] âš ï¸ PhÃ¡t hiá»‡n yÃªu cáº§u giáº£i captcha cho {username}")
                        print(f"[DEBUG] URL khi phÃ¡t hiá»‡n captcha: {driver.current_url}")
                        account["status"] = "âš ï¸ PhÃ¡t hiá»‡n yÃªu cáº§u giáº£i captcha"
                        self.status_updated.emit(username, account["status"])
                        
                        # Giá»¯ cá»­a sá»• báº­t + hiá»ƒn thá»‹ nÃºt tiáº¿p tá»¥c
                        continue_result = self.show_captcha_dialog_safe(driver, username, "captcha")
                        if continue_result:
                            print(f"[DEBUG] User Ä‘Ã£ giáº£i captcha vÃ  nháº¥n tiáº¿p tá»¥c")
                            time.sleep(2)  # Chá» captcha Ä‘Æ°á»£c xá»­ lÃ½
                            
                            # Tiáº¿p tá»¥c cháº¡y theo logic - check láº¡i 2 icon
                            if self.check_home_and_explore_icons(driver):
                                print(f"[SUCCESS] âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng sau giáº£i captcha: {username}")
                                
                                # â­ SUCCESS HANDLING
                                account["status"] = "ğŸ‰ ÄÃ£ vÆ°á»£t qua captcha - ÄÄƒng nháº­p thÃ nh cÃ´ng!"
                                account["last_action"] = f"VÆ°á»£t captcha + Ä‘Äƒng nháº­p lÃºc {time.strftime('%H:%M:%S')}"
                                self.status_updated.emit(username, account["status"])
                                
                                # Background processing
                                from PySide6.QtCore import QCoreApplication
                                import threading
                                QCoreApplication.processEvents()
                                
                                def save_and_cleanup():
                                    try:
                                        self.save_cookies(driver, username)
                                        account["status"] = "ÄÃ£ Ä‘Äƒng nháº­p"
                                        self.status_updated.emit(username, account["status"])
                                    except Exception as e:
                                        print(f"[WARN] Lá»—i khi lÆ°u cookies: {e}")
                                    finally:
                                        self.close_browser_safely(driver, username)
                                
                                threading.Thread(target=save_and_cleanup, daemon=True).start()
                                print(f"[INFO] ===== HOÃ€N Táº¤T CAPTCHA: {username} =====")
                                return "ÄÃ£ Ä‘Äƒng nháº­p", "OK", None
                            else:
                                print(f"[WARN] Captcha Ä‘Ã£ giáº£i nhÆ°ng chÆ°a tháº¥y icons, tiáº¿p tá»¥c chá»...")
                                continue
                        else:
                            print(f"[INFO] User chá»n bá» qua captcha")
                            account["status"] = "ÄÃ£ bá» qua captcha"
                            self.status_updated.emit(username, account["status"])
                            driver.quit()
                            return "ÄÃ£ bá» qua", "Bá» qua", None
                    
                    # KIá»‚M TRA THEO THá»¨ Tá»° YÃŠU Cáº¦U:
                    print(f"[DEBUG] ===== KIá»‚M TRA TRáº NG THÃI ÄÄ‚NG NHáº¬P CHO {username} =====")
                    print(f"[DEBUG] URL hiá»‡n táº¡i: {driver.current_url}")
                    
                    try:
                        title = driver.title
                        print(f"[DEBUG] Title hiá»‡n táº¡i: {title}")
                    except Exception as e:
                        print(f"[DEBUG] Lá»—i khi láº¥y title: {e}")
                    
                    # THá»¨ NHáº¤T: Check icon ngÃ´i nhÃ  á»Ÿ gÃ³c dÆ°á»›i bÃªn trÃ¡i
                    # THá»¨ HAI: Check icon la bÃ n bÃªn cáº¡nh icon ngÃ´i nhÃ  (bÃªn pháº£i)
                    print(f"[DEBUG] BÆ°á»›c 1: Kiá»ƒm tra 2 icon Home + Explore cho {username}")
                    
                    print(f"[DEBUG] Gá»i hÃ m check_home_and_explore_icons cho {username}")
                    try:
                        icons_found = self.check_home_and_explore_icons(driver)
                        print(f"[DEBUG] Káº¿t quáº£ check_home_and_explore_icons: {icons_found}")
                        if icons_found:
                            print(f"[SUCCESS] âœ… ÄÄ‚NG NHáº¬P THÃ€NH CÃ”NG - TÃ¬m tháº¥y cáº£ 2 icon: {username}")
                            print(f"[SUCCESS] URL khi thÃ nh cÃ´ng: {driver.current_url}")
                            
                            # â­ FINAL SUCCESS STATUS - KHÃ”NG CHO PHÃ‰P OVERRIDE
                            account["status"] = "ÄÃ£ Ä‘Äƒng nháº­p"
                            account["last_action"] = f"ÄÄƒng nháº­p thÃ nh cÃ´ng lÃºc {time.strftime('%H:%M:%S')}"
                            
                            # â­ EMIT SIGNAL THÃ€NH CÃ”NG TRÆ¯á»šC KHI BACKGROUND PROCESSING
                            self.status_updated.emit(username, account["status"])
                            
                            # â­ FORCE UI UPDATE NGAY Láº¬P Tá»¨C
                            from PySide6.QtCore import QCoreApplication
                            QCoreApplication.processEvents()
                            
                            # â­ LÆ¯U VÃ€O FILE NGAY Láº¬P Tá»¨C Äá»‚ Äáº¢M Báº¢O TRáº NG THÃI
                            self.save_accounts()
                            
                            # Thread cho viá»‡c lÆ°u cookies vÃ  cleanup (KHÃ”NG EMIT SIGNAL Ná»®A)
                            def save_and_cleanup():
                                try:
                                    print(f"[DEBUG] Background: Äang lÆ°u cookies cho {username}")
                                    self.save_cookies(driver, username)
                                    print(f"[INFO] Background: âœ… ÄÃ£ lÆ°u cookies cho {username}")
                                except Exception as e:
                                    print(f"[WARN] Background: Lá»—i khi lÆ°u cookies: {e}")
                                finally:
                                    try:
                                        self.close_browser_safely(driver, username)
                                        print(f"[INFO] Background: ÄÃ£ Ä‘Ã³ng browser cho {username}")
                                    except Exception as e:
                                        print(f"[WARN] Background: Lá»—i khi Ä‘Ã³ng browser: {e}")
                            
                            # Báº¯t Ä‘áº§u background task
                            import threading
                            threading.Thread(target=save_and_cleanup, daemon=True).start()
                            
                            print(f"[SUCCESS] ===== HOÃ€N Táº¤T ÄÄ‚NG NHáº¬P THÃ€NH CÃ”NG: {username} =====")
                            return "ÄÃ£ Ä‘Äƒng nháº­p", "OK", None
                    except Exception as e:
                        print(f"[ERROR] Lá»—i khi check icons: {e}")
                        import traceback
                        traceback.print_exc()
                    
                    # KIá»‚M TRA FORM Lá»®U THÃ”NG TIN ÄÄ‚NG NHáº¬P (SAVE LOGIN INFO)
                    if self.check_save_login_info(driver):
                        print(f"[INFO] ğŸ’¾ PhÃ¡t hiá»‡n form lÆ°u thÃ´ng tin Ä‘Äƒng nháº­p cho {username}")
                        account["status"] = "Äang xá»­ lÃ½ form lÆ°u thÃ´ng tin Ä‘Äƒng nháº­p"
                        self.status_updated.emit(username, account["status"])
                        
                        # Xá»­ lÃ½ form - chá»n "Not Now" Ä‘á»ƒ tiáº¿p tá»¥c
                        if self.handle_save_login_info(driver, username):
                            print(f"[SUCCESS] ÄÃ£ xá»­ lÃ½ form lÆ°u thÃ´ng tin Ä‘Äƒng nháº­p cho {username}")
                            # âš¡ Tá»I Æ¯U: Giáº£m thá»i gian chá» sau xá»­ lÃ½ form
                            time.sleep(1)  # âš¡ Giáº£m tá»« 2s xuá»‘ng 1s
                            if self.check_home_and_explore_icons(driver):
                                print(f"[SUCCESS] âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng sau xá»­ lÃ½ form lÆ°u thÃ´ng tin: {username}")
                                
                                # â­ Tá»I Æ¯U: Immediate feedback sau xá»­ lÃ½ form
                                account["status"] = "ğŸ‰ ÄÄƒng nháº­p thÃ nh cÃ´ng (form processed)!"
                                account["last_action"] = f"Xá»­ lÃ½ form + Ä‘Äƒng nháº­p lÃºc {time.strftime('%H:%M:%S')}"
                                self.status_updated.emit(username, account["status"])
                                
                                # Background processing
                                from PySide6.QtCore import QCoreApplication
                                import threading
                                QCoreApplication.processEvents()
                                
                                def save_and_cleanup():
                                    try:
                                        self.save_cookies(driver, username)
                                        account["status"] = "ÄÃ£ Ä‘Äƒng nháº­p"
                                        self.status_updated.emit(username, account["status"])
                                    except Exception as e:
                                        print(f"[WARN] Lá»—i khi lÆ°u cookies: {e}")
                                    finally:
                                        self.close_browser_safely(driver, username)
                                
                                threading.Thread(target=save_and_cleanup, daemon=True).start()
                                print(f"[INFO] ===== HOÃ€N Táº¤T: {username} =====")
                                return "ÄÃ£ Ä‘Äƒng nháº­p", "OK", None
                        else:
                            print(f"[WARN] KhÃ´ng thá»ƒ xá»­ lÃ½ form lÆ°u thÃ´ng tin Ä‘Äƒng nháº­p cho {username}")
                            # Váº«n tiáº¿p tá»¥c logic, cÃ³ thá»ƒ form tá»± Ä‘Ã³ng
                    
                    # KIá»‚M TRA YÃŠU Cáº¦U XÃC MINH DANH TÃNH
                    if self.check_identity_verification_required(driver):
                        print(f"[WARN] ğŸ” TÃ i khoáº£n {username} cáº§n xÃ¡c minh danh tÃ­nh")
                        account["status"] = "Cáº§n xÃ¡c minh danh tÃ­nh"
                        self.status_updated.emit(username, account["status"])
                        
                        # Giá»¯ cá»­a sá»• má»Ÿ Ä‘á»ƒ user xÃ¡c minh
                        continue_result = self.show_captcha_dialog_safe(driver, username, "identity_verification")
                        if continue_result:
                            # Kiá»ƒm tra láº¡i sau khi user xá»­ lÃ½
                            if self.check_home_and_explore_icons(driver):
                                print(f"[SUCCESS] âœ… ÄÃ£ xÃ¡c minh danh tÃ­nh thÃ nh cÃ´ng: {username}")
                                account["status"] = "ğŸ‰ ÄÃ£ xÃ¡c minh danh tÃ­nh - ÄÄƒng nháº­p thÃ nh cÃ´ng!"
                                self.status_updated.emit(username, account["status"])
                                
                                # Background processing
                                from PySide6.QtCore import QCoreApplication
                                import threading
                                QCoreApplication.processEvents()
                                
                                def save_and_cleanup():
                                    try:
                                        self.save_cookies(driver, username)
                                        account["status"] = "ÄÃ£ Ä‘Äƒng nháº­p"
                                        self.status_updated.emit(username, account["status"])
                                    except Exception as e:
                                        print(f"[WARN] Lá»—i khi lÆ°u cookies: {e}")
                                    finally:
                                        self.close_browser_safely(driver, username)
                                
                                threading.Thread(target=save_and_cleanup, daemon=True).start()
                                print(f"[INFO] ===== HOÃ€N Táº¤T: {username} =====")
                                return "ÄÃ£ Ä‘Äƒng nháº­p", "OK", None
                        else:
                            print(f"[INFO] User chá»n bá» qua xÃ¡c minh danh tÃ­nh")
                            account["status"] = "ÄÃ£ bá» qua xÃ¡c minh danh tÃ­nh"
                            self.status_updated.emit(username, account["status"])
                            driver.quit()
                            return "ÄÃ£ bá» qua", "Bá» qua", None
                    
                    # KIá»‚M TRA TÃ€I KHOáº¢N Bá»Š KHÃ“A (tháº­t sá»± nghiÃªm trá»ng)
                    elif self.check_account_locked(driver):
                        print(f"[ERROR] âŒ TÃ i khoáº£n {username} bá»‹ khÃ³a")
                        account["status"] = "TÃ i khoáº£n Die"
                        self.status_updated.emit(username, account["status"])
                        # ÄÃ³ng trÃ¬nh duyá»‡t
                        driver.quit()
                        print(f"[INFO] ÄÃ£ Ä‘Ã³ng trÃ¬nh duyá»‡t cho {username}")
                        print(f"[INFO] ===== HOÃ€N Táº¤T: {username} =====")
                        return "TÃ i khoáº£n Die", "Die", None
                    
                    else:
                        print(f"[DEBUG] ChÆ°a xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c tráº¡ng thÃ¡i cho {username} - tiáº¿p tá»¥c chá»...")
                    
                except Exception as e:
                    print(f"[ERROR] Lá»—i khi kiá»ƒm tra tráº¡ng thÃ¡i: {e}")
                    
                    # Kiá»ƒm tra náº¿u lÃ  lá»—i session bá»‹ máº¥t káº¿t ná»‘i
                    error_msg = str(e).lower()
                    if "invalid session id" in error_msg or "session deleted" in error_msg or "not connected to devtools" in error_msg:
                        print(f"[ERROR] Browser Ä‘Ã£ bá»‹ Ä‘Ã³ng hoáº·c máº¥t káº¿t ná»‘i cho {username}")
                        account["status"] = "Lá»—i: Browser bá»‹ Ä‘Ã³ng"
                        self.status_updated.emit(username, account["status"])
                        # ThoÃ¡t khá»i vÃ²ng láº·p vÃ¬ khÃ´ng thá»ƒ tiáº¿p tá»¥c
                        break
                    
                    continue
            
            # â­ Tá»I Æ¯U: TIMEOUT - KHÃ”NG XÃC Äá»ŠNH ÄÆ¯á»¢C TRáº NG THÃI
            print(f"[WARN] â° Timeout khi Ä‘Äƒng nháº­p {username}")
            account["status"] = "â° Timeout Ä‘Äƒng nháº­p"
            account["last_action"] = f"Timeout Ä‘Äƒng nháº­p lÃºc {time.strftime('%H:%M:%S')}"
            self.status_updated.emit(username, account["status"])
            
            # â­ Tá»I Æ¯U: Force UI update ngay láº­p tá»©c
            from PySide6.QtCore import QCoreApplication
            QCoreApplication.processEvents()
            
            # â­ Tá»I Æ¯U: ÄÃ³ng browser trong background
            if driver:
                import threading
                def close_timeout_browser():
                    try:
                        self.close_browser_safely(driver, username)
                    except Exception as e:
                        print(f"[WARN] Lá»—i khi Ä‘Ã³ng browser timeout: {e}")
                
                threading.Thread(target=close_timeout_browser, daemon=True).start()
            
            return "Timeout", "Timeout", None
            
        except Exception as e:
            print(f"[ERROR] âŒ Lá»—i khÃ´ng mong muá»‘n khi Ä‘Äƒng nháº­p {username}: {e}")
            print(f"[DEBUG] Chi tiáº¿t lá»—i: {type(e).__name__}: {str(e)}")
            
            # â­ QUAN TRá»ŒNG: Kiá»ƒm tra xem cÃ³ pháº£i Ä‘Ã£ Ä‘Äƒng nháº­p thÃ nh cÃ´ng nhÆ°ng bá»‹ timeout khÃ´ng
            print(f"[DEBUG] ===== KIá»‚M TRA CUá»I CÃ™NG SAU Lá»–I CHO {username} =====")
            
            # Cáº­p nháº­t status táº¡m thá»i
            account["status"] = "âŒ Lá»—i - Äang kiá»ƒm tra cuá»‘i cÃ¹ng..."
            self.status_updated.emit(username, account["status"])
            
            # Force UI update
            from PySide6.QtCore import QCoreApplication
            QCoreApplication.processEvents()
            
            try:
                # â­ KIá»‚M TRA CUá»I CÃ™NG: CÃ³ thá»ƒ Ä‘Ã£ Ä‘Äƒng nháº­p thÃ nh cÃ´ng nhÆ°ng bá»‹ timeout
                if driver and self.check_home_and_explore_icons(driver):
                    print(f"[SUCCESS] âœ… ÄÄ‚NG NHáº¬P THÃ€NH CÃ”NG SAU Lá»–I: {username}")
                    print(f"[INFO] Lá»—i chá»‰ lÃ  timeout/communication issue, tÃ i khoáº£n Ä‘Ã£ Ä‘Äƒng nháº­p!")
                    
                    # â­ IMMEDIATE SUCCESS FEEDBACK
                    account["status"] = "ğŸ‰ ÄÄƒng nháº­p thÃ nh cÃ´ng (sau lá»—i)!"
                    account["last_action"] = f"ÄÄƒng nháº­p thÃ nh cÃ´ng sau lá»—i lÃºc {time.strftime('%H:%M:%S')}"
                    self.status_updated.emit(username, account["status"])
                    QCoreApplication.processEvents()
                    
                    # â­ Background processing
                    import threading
                    def save_after_error():
                        try:
                            print(f"[DEBUG] LÆ°u cookies sau lá»—i cho {username}")
                            self.save_cookies(driver, username)
                            
                            # Final status update
                            account["status"] = "ÄÃ£ Ä‘Äƒng nháº­p"
                            self.status_updated.emit(username, account["status"])
                            print(f"[SUCCESS] âœ… LÆ°u cookies thÃ nh cÃ´ng sau lá»—i cho {username}")
                            
                        except Exception as save_error:
                            print(f"[WARN] Lá»—i khi lÆ°u cookies sau error recovery: {save_error}")
                        finally:
                            try:
                                self.close_browser_safely(driver, username)
                            except Exception as close_error:
                                print(f"[WARN] Lá»—i Ä‘Ã³ng browser sau error recovery: {close_error}")
                    
                    threading.Thread(target=save_after_error, daemon=True).start()
                    print(f"[SUCCESS] ===== ERROR RECOVERY THÃ€NH CÃ”NG: {username} =====")
                    return "ÄÃ£ Ä‘Äƒng nháº­p", "OK", None
                    
                else:
                    print(f"[INFO] Kiá»ƒm tra cuá»‘i cÃ¹ng khÃ´ng thÃ nh cÃ´ng - tháº­t sá»± cÃ³ lá»—i: {username}")
                    
            except Exception as final_check_error:
                print(f"[ERROR] Lá»—i trong final check sau exception: {final_check_error}")
            
            # â­ THáº¬T Sá»° CÃ“ Lá»–I - cáº­p nháº­t status
            error_msg = str(e)[:100] + "..." if len(str(e)) > 100 else str(e)
            account["status"] = f"âŒ Lá»—i: {error_msg}"
            account["last_action"] = f"Lá»—i Ä‘Äƒng nháº­p lÃºc {time.strftime('%H:%M:%S')}"
            
            # Emit signal Ä‘á»ƒ cáº­p nháº­t UI cho cÃ¡c trÆ°á»ng há»£p lá»—i
            self.status_updated.emit(username, account["status"])
            QCoreApplication.processEvents()
            
            # â­ Tá»I Æ¯U: Cleanup browser trong background
            if driver:
                import threading
                def cleanup_error_browser():
                    try:
                        self.close_browser_safely(driver, username)
                    except Exception as cleanup_error:
                        print(f"[WARN] Lá»—i khi cleanup browser: {cleanup_error}")
                
                threading.Thread(target=cleanup_error_browser, daemon=True).start()
                
            return "Lá»—i khÃ´ng mong muá»‘n", "Lá»—i", None

    def close_all_drivers(self):
        # ÄÃ³ng tá»«ng driver trong thread riÃªng biá»‡t Ä‘á»ƒ khÃ´ng block GUI
        import threading
        def close_driver_safe(driver):
            try:
                driver.quit()
            except Exception as e:
                print(f"[WARN] Lá»—i khi Ä‘Ã³ng trÃ¬nh duyá»‡t: {e}")
        for d in self.active_drivers:
            threading.Thread(target=close_driver_safe, args=(d["driver"] if isinstance(d, dict) and "driver" in d else d,)).start()
        self.active_drivers = []
        print("[INFO] ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c trÃ¬nh duyá»‡t.")

    def import_accounts(self):
        """Nháº­p danh sÃ¡ch tÃ i khoáº£n tá»« file (há»— trá»£ .json, .txt, .csv)."""
        file_path, _ = QFileDialog.getOpenFileName(self, "Nháº­p tÃ i khoáº£n", "", "All Supported (*.json *.txt *.csv);;JSON Files (*.json);;Text Files (*.txt);;CSV Files (*.csv)")
        if not file_path:
            return
        try:
            imported_accounts = []
            if file_path.endswith('.json'):
                with open(file_path, 'r', encoding='utf-8') as f:
                    imported_accounts = json.load(f)
            elif file_path.endswith('.txt'):
                with open(file_path, 'r', encoding='utf-8') as f:
                    for line in f:
                        line = line.strip()
                        if line:
                            # Há»— trá»£: username hoáº·c username,password hoáº·c username,password,proxy
                            parts = [p.strip() for p in line.split(',')]
                            if len(parts) == 1:
                                imported_accounts.append({"username": parts[0], "password": "", "proxy": ""})
                            elif len(parts) == 2:
                                imported_accounts.append({"username": parts[0], "password": parts[1], "proxy": ""})
                            elif len(parts) >= 3:
                                imported_accounts.append({"username": parts[0], "password": parts[1], "proxy": parts[2]})
            elif file_path.endswith('.csv'):
                import csv
                with open(file_path, 'r', encoding='utf-8') as f:
                    reader = csv.reader(f)
                    for row in reader:
                        if not row: continue
                        # Há»— trá»£: username,password,proxy
                        username = row[0].strip() if len(row) > 0 else ""
                        password = row[1].strip() if len(row) > 1 else ""
                        proxy = row[2].strip() if len(row) > 2 else ""
                        if username:
                            imported_accounts.append({"username": username, "password": password, "proxy": proxy})
            else:
                QMessageBox.warning(self, "Lá»—i", "Äá»‹nh dáº¡ng file khÃ´ng Ä‘Æ°á»£c há»— trá»£!")
                return

            # Láº¥y danh sÃ¡ch username hiá»‡n táº¡i (khÃ´ng phÃ¢n biá»‡t hoa thÆ°á»ng)
            existing_usernames = set(acc.get("username", "").lower() for acc in self.accounts)
            # Loáº¡i bá» tÃ i khoáº£n trÃ¹ng username trong chÃ­nh file import
            seen = set()
            unique_imported_accounts = []
            for acc in imported_accounts:
                uname = acc.get("username", "").lower()
                if uname and uname not in seen:
                    seen.add(uname)
                    unique_imported_accounts.append(acc)
            # Lá»c ra cÃ¡c tÃ i khoáº£n má»›i chÆ°a cÃ³ trong báº£ng hiá»‡n táº¡i
            new_accounts = [acc for acc in unique_imported_accounts if acc.get("username", "").lower() not in existing_usernames]
            if not new_accounts:
                QMessageBox.information(self, "ThÃ´ng bÃ¡o", "KhÃ´ng cÃ³ tÃ i khoáº£n má»›i nÃ o Ä‘Æ°á»£c thÃªm (táº¥t cáº£ Ä‘á»u Ä‘Ã£ tá»“n táº¡i trong báº£ng hiá»‡n táº¡i).")
            else:
                # Bá»• sung cÃ¡c trÆ°á»ng máº·c Ä‘á»‹nh náº¿u thiáº¿u
                for acc in new_accounts:
                    acc.setdefault("selected", False)
                    acc.setdefault("fullname", "")
                    acc.setdefault("status", "ChÆ°a Ä‘Äƒng nháº­p")
                    acc.setdefault("gender", "-")
                    acc.setdefault("followers", "")
                    acc.setdefault("following", "")
                    acc.setdefault("last_action", "")
                    acc.setdefault("proxy_status", "ChÆ°a kiá»ƒm tra")
                    acc.setdefault("permanent_proxy", "")  # â­ THÃŠM: Proxy vÄ©nh viá»…n cho tÃ i khoáº£n
                self.accounts.extend(new_accounts)
                self.save_accounts()
                self.update_account_table()
                QMessageBox.information(self, "ThÃ nh cÃ´ng", f"ÄÃ£ nháº­p {len(new_accounts)} tÃ i khoáº£n má»›i thÃ nh cÃ´ng!")
        except Exception as e:
            QMessageBox.critical(self, "Lá»—i", f"KhÃ´ng thá»ƒ nháº­p tÃ i khoáº£n: {str(e)}")

    def open_folder_manager(self):
        # Kiá»ƒm tra xem self.folder_map cÃ³ Ä‘Æ°á»£c khá»Ÿi táº¡o khÃ´ng
        if not hasattr(self, 'folder_map'):
            self.folder_map = self.load_folder_map()
        from src.ui.folder_manager import FolderManagerDialog  # Import á»Ÿ Ä‘Ã¢y Ä‘á»ƒ trÃ¡nh lá»—i circular dependency
        dialog = FolderManagerDialog(self.accounts, self.folder_map, self)  # Truyá»n self.accounts vÃ  self.folder_map
        dialog.folders_updated.connect(self.on_folders_updated)  # Káº¿t ná»‘i tÃ­n hiá»‡u cáº­p nháº­t thÆ° má»¥c
        dialog.exec()

    def load_folder_list_to_combo(self):
        self.category_combo.clear()
        self.category_combo.addItem("Táº¥t cáº£")
        # LuÃ´n load láº¡i folder_map tá»« file Ä‘á»ƒ Ä‘áº£m báº£o má»›i nháº¥t
        folder_map = self.load_folder_map()
        if folder_map and "_FOLDER_SET_" in folder_map:
            for folder in folder_map["_FOLDER_SET_"]:
                if folder != "Tá»•ng":
                    self.category_combo.addItem(folder)
        print(f"[DEBUG] ÄÃ£ táº£i danh sÃ¡ch thÆ° má»¥c vÃ o combobox: {folder_map.get('_FOLDER_SET_', [])}")

    def on_folder_changed(self):
        selected_folder = self.category_combo.currentText()
        if selected_folder == "Táº¥t cáº£":
            self.update_account_table(self.accounts)
        else:
            filtered_accounts = [acc for acc in self.accounts if self.folder_map.get(acc.get("username"), "Tá»•ng") == selected_folder]
            self.update_account_table(filtered_accounts)
        print(f"[DEBUG] ÄÃ£ lá»c tÃ i khoáº£n theo thÆ° má»¥c: {selected_folder}")

    def on_folders_updated(self):
        # Khi thÆ° má»¥c Ä‘Æ°á»£c cáº­p nháº­t trong FolderManagerDialog, cáº­p nháº­t láº¡i combobox vÃ  báº£ng
        print("[DEBUG] TÃ­n hiá»‡u folders_updated Ä‘Ã£ Ä‘Æ°á»£c nháº­n trong AccountManagementTab.")
        self.folder_map = self.load_folder_map()  # Táº£i láº¡i folder_map má»›i nháº¥t
        self.load_folder_list_to_combo()  # Cáº­p nháº­t combobox
        self.update_account_table()  # Cáº­p nháº­t báº£ng tÃ i khoáº£n Ä‘á»ƒ pháº£n Ã¡nh thay Ä‘á»•i thÆ° má»¥c
        # â­ PHÃT TÃN HIá»†U Äá»‚ Äá»’NG Bá»˜ Vá»šI CÃC TAB KHÃC
        self.folders_updated.emit()

    def show_context_menu(self, pos):
        """Hiá»ƒn thá»‹ menu chuá»™t pháº£i."""
        print(f"[DEBUG] show_context_menu Ä‘Æ°á»£c gá»i táº¡i vá»‹ trÃ­: {pos}")
        menu = AccountContextMenu(self)
        menu.exec(self.account_table.viewport().mapToGlobal(pos))

    def on_table_item_double_clicked(self, index):
        selected_account: dict = self.accounts[index.row()]
        QMessageBox.information(self, "Chi tiáº¿t tÃ i khoáº£n", 
            f"TÃªn Ä‘Äƒng nháº­p: {selected_account.get('username', 'N/A')}\n"
            f"Máº­t kháº©u: {selected_account.get('password', 'N/A')}\n"
            f"Tráº¡ng thÃ¡i: {selected_account.get('status', 'N/A')}\n"
            f"Proxy: {selected_account.get('proxy', 'N/A')}\n"
            f"Tráº¡ng thÃ¡i Proxy: {selected_account.get('proxy_status', 'N/A')}\n"
            f"Follower: {selected_account.get('followers', 'N/A')}\n"
            f"Following: {selected_account.get('following', 'N/A')}\n"
            f"HÃ nh Ä‘á»™ng cuá»‘i: {selected_account.get('last_action', 'N/A')}")

    @Slot(str, str)
    def on_status_updated(self, username, status):
        """Update tráº¡ng thÃ¡i tá»« thread má»™t cÃ¡ch an toÃ n"""
        print(f"[DEBUG] on_status_updated Ä‘Æ°á»£c gá»i cho {username} vá»›i status: {status}")
        
        # â­ THÃŠM NOTIFICATION CHO ÄÄ‚NG NHáº¬P THÃ€NH CÃ”NG
        if status == "ÄÃ£ Ä‘Äƒng nháº­p" or "Ä‘Äƒng nháº­p thÃ nh cÃ´ng" in status.lower():
            print(f"[SUCCESS] ğŸ‰ THÃ”NG BÃO: {username} Ä‘Ã£ Ä‘Äƒng nháº­p thÃ nh cÃ´ng!")
            
            # Hiá»ƒn thá»‹ notification popup nhanh
            try:
                from PySide6.QtWidgets import QMessageBox
                from PySide6.QtCore import QTimer
                
                # Táº¡o má»™t notification toast ngáº¯n gá»n
                def show_success_toast():
                    toast = QMessageBox(self)
                    toast.setWindowTitle("ÄÄƒng nháº­p thÃ nh cÃ´ng")
                    toast.setText(f"âœ… {username} Ä‘Ã£ Ä‘Äƒng nháº­p thÃ nh cÃ´ng!")
                    toast.setIcon(QMessageBox.Icon.Information)
                    toast.setStandardButtons(QMessageBox.StandardButton.NoButton)
                    
                    # Auto close sau 2 giÃ¢y
                    QTimer.singleShot(2000, toast.close)
                    toast.show()
                    
                    # Focus vÃ o cá»­a sá»• chÃ­nh Ä‘á»ƒ user biáº¿t
                    self.window().raise_()
                    self.window().activateWindow()
                
                # Hiá»ƒn thá»‹ toast sau 500ms Ä‘á»ƒ Ä‘áº£m báº£o UI Ä‘Ã£ cáº­p nháº­t
                QTimer.singleShot(500, show_success_toast)
                
            except Exception as toast_error:
                print(f"[WARN] KhÃ´ng thá»ƒ hiá»ƒn thá»‹ notification toast: {toast_error}")
        
        # TÃ¬m vÃ  cáº­p nháº­t account trong danh sÃ¡ch
        found = False
        account_row = -1
        for i, account in enumerate(self.accounts):
            if account.get("username") == username:
                # â­ KHÃ”NG CHO PHÃ‰P OVERRIDE STATUS "ÄÃ£ Ä‘Äƒng nháº­p" 
                current_status = account.get("status", "")
                if current_status == "ÄÃ£ Ä‘Äƒng nháº­p" and status != "ÄÃ£ Ä‘Äƒng nháº­p":
                    # Bá» qua náº¿u Ä‘ang cá»‘ override status Ä‘Äƒng nháº­p thÃ nh cÃ´ng
                    if "Ä‘ang" in status.lower() or "Ä‘Ã£" not in status.lower():
                        print(f"[DEBUG] Bá» qua override status '{status}' vÃ¬ tÃ i khoáº£n {username} Ä‘Ã£ Ä‘Äƒng nháº­p thÃ nh cÃ´ng")
                        return
                
                account["status"] = status
                account["last_action"] = f"Cáº­p nháº­t: {status} lÃºc {time.strftime('%H:%M:%S')}"
                found = True
                account_row = i
                print(f"[DEBUG] TÃ¬m tháº¥y account {username} á»Ÿ row {i}, Ä‘Ã£ cáº­p nháº­t status")
                break
        
        if not found:
            print(f"[ERROR] KhÃ´ng tÃ¬m tháº¥y account {username} trong danh sÃ¡ch accounts!")
            return
        
        # LÆ°u accounts
        self.save_accounts()
        
        # Cáº­p nháº­t chá»‰ Ã´ tráº¡ng thÃ¡i thay vÃ¬ toÃ n bá»™ báº£ng Ä‘á»ƒ trÃ¡nh dataChanged error
        try:
            if account_row >= 0 and account_row < self.account_table.rowCount():
                # Block signals Ä‘á»ƒ trÃ¡nh lá»—i dataChanged
                self.account_table.blockSignals(True)
                
                # Cáº­p nháº­t chá»‰ Ã´ tráº¡ng thÃ¡i (cá»™t 4)
                status_item = self.account_table.item(account_row, 4)
                if status_item:
                    status_item.setText(status)
                    
                    # â­ Cáº¢I THIá»†N MÃ€U Sáº®C VÃ€ HIá»†U á»¨NG CHO ÄÄ‚NG NHáº¬P THÃ€NH CÃ”NG
                    if status == "ÄÃ£ Ä‘Äƒng nháº­p" or "Ä‘Äƒng nháº­p thÃ nh cÃ´ng" in status.lower():
                        status_item.setForeground(QColor("#4CAF50"))  # Xanh lÃ¡ Ä‘áº­m hÆ¡n
                        status_item.setBackground(QColor("#E8F5E8"))  # Ná»n xanh nháº¡t
                        # ThÃªm icon success
                        status_item.setText(f"âœ… {status}")
                    elif status == "ÄÄƒng nháº­p tháº¥t báº¡i" or "Lá»—i" in status:
                        status_item.setForeground(QColor("#F44336"))  # Äá»
                        status_item.setBackground(QColor("#FFEBEE"))  # Ná»n Ä‘á» nháº¡t
                        status_item.setText(f"âŒ {status}")
                    elif status == "Die" or "khÃ³a" in status.lower():
                        status_item.setForeground(QColor("#FF5722"))  # Äá» cam
                        status_item.setBackground(QColor("#FFF3E0"))  # Ná»n cam nháº¡t
                        status_item.setText(f"ğŸš« {status}")
                    elif "checkpoint" in status.lower() or "captcha" in status.lower():
                        status_item.setForeground(QColor("#FF9800"))  # Cam
                        status_item.setBackground(QColor("#FFF8E1"))  # Ná»n vÃ ng nháº¡t
                        status_item.setText(f"âš ï¸ {status}")
                    else:
                        status_item.setForeground(QColor("#333333"))  # XÃ¡m Ä‘en
                        status_item.setBackground(QColor("#ffffff"))  # Ná»n tráº¯ng
                
                # â­ Cáº¬P NHáº¬T Cá»˜T "HÃ€NH Äá»˜NG CUá»I" CÅ¨NG ÄÆ¯á»¢C HIGHLIGHT
                last_action_item = self.account_table.item(account_row, 10)  # Cá»™t cuá»‘i cÃ¹ng
                if last_action_item:
                    last_action_text = f"Cáº­p nháº­t: {status} lÃºc {time.strftime('%H:%M:%S')}"
                    last_action_item.setText(last_action_text)
                    
                    if status == "ÄÃ£ Ä‘Äƒng nháº­p":
                        last_action_item.setForeground(QColor("#4CAF50"))
                        last_action_item.setText(f"ğŸ‰ {last_action_text}")
                
                # Unblock signals
                self.account_table.blockSignals(False)
                
                # Force repaint
                self.account_table.viewport().update()
                
                print(f"[DEBUG] ÄÃ£ cáº­p nháº­t UI trá»±c tiáº¿p cho {username}: {status}")
            else:
                print(f"[ERROR] Row {account_row} khÃ´ng há»£p lá»‡ cho báº£ng cÃ³ {self.account_table.rowCount()} rows")
                
        except Exception as e:
            print(f"[ERROR] Lá»—i khi cáº­p nháº­t UI cho {username}: {e}")
            # Äáº£m báº£o unblock signals
            self.account_table.blockSignals(False)
            
        # Cáº­p nháº­t thá»‘ng kÃª
        self.update_stats()

    def toggle_all_accounts_selection(self, checked):
        # Chá»‰ tick/bá» tick cÃ¡c dÃ²ng Ä‘ang hiá»ƒn thá»‹ (khÃ´ng bá»‹ áº©n)
        for row_idx in range(self.account_table.rowCount()):
            if not self.account_table.isRowHidden(row_idx):
                item = self.account_table.item(row_idx, 0)
                if item:
                    model_index = self.account_table.model().index(row_idx, 0)
                    self.account_table.model().setData(model_index, checked, CheckboxDelegate.CheckboxStateRole)
                    # Cáº­p nháº­t tráº¡ng thÃ¡i 'selected' trong dá»¯ liá»‡u tÃ i khoáº£n gá»‘c
                    username = self.account_table.item(row_idx, 2).text()
                    for acc in self.accounts:
                        if acc.get("username", "") == username:
                            acc["selected"] = checked
        self.save_accounts()
        self.update_account_table()
        self.update_stats()

    def load_proxies(self):
        proxies = []
        proxies_file = "proxies.txt"
        if os.path.exists(proxies_file):
            with open(proxies_file, 'r', encoding='utf-8-sig') as f:
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#'):
                        parts = line.split(':')
                        if len(parts) == 4:
                            ip, port, user, password = parts
                            proxies.append({"ip": ip, "port": port, "user": user, "pass": password, "status": "ChÆ°a kiá»ƒm tra", "is_in_use": False, "usage_count": 0})
                        elif len(parts) == 2:  # No auth proxy
                            ip, port = parts
                            proxies.append({"ip": ip, "port": port, "user": "", "pass": "", "status": "ChÆ°a kiá»ƒm tra", "is_in_use": False, "usage_count": 0})
                        else:
                            print(f"[WARN] Äá»‹nh dáº¡ng proxy khÃ´ng há»£p lá»‡, bá» qua: {line}")
        print(f"[DEBUG] ÄÃ£ táº£i {len(proxies)} proxy.")
        return proxies

    def load_folder_map(self):
        if os.path.exists(self.folder_map_file):
            try:
                with open(self.folder_map_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except json.JSONDecodeError:
                print("[ERROR] Lá»—i Ä‘á»c file folder_map.json. File cÃ³ thá»ƒ bá»‹ há»ng. Táº¡o láº¡i map trá»‘ng.")
                return {}
        return {}

    def _assign_new_proxy(self, account):
        """TÃ¬m vÃ  gÃ¡n má»™t proxy má»›i cho tÃ i khoáº£n náº¿u proxy hiá»‡n táº¡i bá»‹ lá»—i hoáº·c cáº§n xoay vÃ²ng."""
        current_proxy = account.get("proxy", "")
        username = account.get("username", "")
        print(f"[DEBUG] Äang tÃ¬m proxy má»›i cho tÃ i khoáº£n {username}. Proxy hiá»‡n táº¡i: {current_proxy}")

        new_proxy_info = None

        # --- Æ¯u tiÃªn 1: TÃ¬m má»™t proxy chÆ°a Ä‘Æ°á»£c sá»­ dá»¥ng (not in use) vÃ  cÃ³ sá»‘ láº§n sá»­ dá»¥ng tháº¥p (< PROXY_USAGE_THRESHOLD) ---
        for proxy_info in self.proxies:
            if (proxy_info.get("status") == "OK" or proxy_info.get("status") == "ChÆ°a kiá»ƒm tra") and \
               not proxy_info.get("is_in_use", False) and \
               proxy_info.get("usage_count", 0) < self.PROXY_USAGE_THRESHOLD:
                new_proxy_info = proxy_info
                print(f"[DEBUG] ÄÃ£ tÃ¬m tháº¥y proxy Æ°u tiÃªn (tháº¥p sá»­ dá»¥ng): {proxy_info.get('ip')}. Usage: {proxy_info.get('usage_count')}")
                break

        # --- Æ¯u tiÃªn 2: Fallback Ä‘áº¿n báº¥t ká»³ proxy nÃ o chÆ°a Ä‘Æ°á»£c sá»­ dá»¥ng vÃ  cÃ³ tráº¡ng thÃ¡i tá»‘t (báº¥t ká»ƒ usage_count) ---
        if not new_proxy_info:
            print("[DEBUG] KhÃ´ng tÃ¬m tháº¥y proxy Æ°u tiÃªn, Ä‘ang tÃ¬m proxy kháº£ dá»¥ng báº¥t ká»³.")
            for proxy_info in self.proxies:
                if (proxy_info.get("status") == "OK" or proxy_info.get("status") == "ChÆ°a kiá»ƒm tra") and \
                   not proxy_info.get("is_in_use", False):
                    new_proxy_info = proxy_info
                    print(f"[DEBUG] ÄÃ£ tÃ¬m tháº¥y proxy kháº£ dá»¥ng: {proxy_info.get('ip')}. Usage: {proxy_info.get('usage_count')}")
                    break

        if new_proxy_info:
            account["proxy"] = f"{new_proxy_info.get('ip')}:{new_proxy_info.get('port')}:{new_proxy_info.get('user')}:{new_proxy_info.get('pass')}"
            new_proxy_info["is_in_use"] = True  # ÄÃ¡nh dáº¥u lÃ  Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng khi gÃ¡n
            new_proxy_info["status"] = "Äang sá»­ dá»¥ng"  # Cáº­p nháº­t tráº¡ng thÃ¡i proxy trong danh sÃ¡ch toÃ n cáº§u
            account["proxy_status"] = "Äang chuyá»ƒn Ä‘á»•i"  # ÄÃ¡nh dáº¥u tráº¡ng thÃ¡i tÃ i khoáº£n Ä‘ang chuyá»ƒn Ä‘á»•i proxy
            print(f"[INFO] ÄÃ£ gÃ¡n proxy má»›i {account['proxy']} cho tÃ i khoáº£n {username}.")
        else:
            account["proxy_status"] = "KhÃ´ng cÃ³ proxy kháº£ dá»¥ng"  # Náº¿u khÃ´ng tÃ¬m tháº¥y proxy nÃ o phÃ¹ há»£p
            print(f"[WARN] KhÃ´ng tÃ¬m tháº¥y proxy kháº£ dá»¥ng nÃ o cho tÃ i khoáº£n {username}.")

        self.save_accounts()  # LÆ°u thay Ä‘á»•i vÃ o accounts.json

    def _perform_warmup(self, driver, delay_multiplier):
        # Implementation of _perform_warmup method
        driver.get("https://www.instagram.com")
        time.sleep(2 * delay_multiplier)
        # Simulate scrolling down
        driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
        time.sleep(2 * delay_multiplier)
        # Simulate clicking on a random post or exploring
        try:
            # Find a post link and click it (simple example)
            post_links = driver.find_elements(By.XPATH, "//a[contains(@href, '/p/')]") 
            if post_links:
                random_post = random.choice(post_links)
                random_post.click()
                time.sleep(5 * delay_multiplier)  # Spend some time on the post
                driver.back()  # Go back to home feed
                time.sleep(2 * delay_multiplier)
        except Exception as e:
            print(f"[WARN] Lá»—i khi thá»±c hiá»‡n warm-up: {e}")
        print("[DEBUG] ÄÃ£ hoÃ n táº¥t phiÃªn warm-up.")

    def get_info_selected_accounts(self):
        QMessageBox.information(self, "Chá»©c nÄƒng", "Láº¥y thÃ´ng tin tÃ i khoáº£n Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn.")
        print("[DEBUG] Chá»©c nÄƒng get_info_selected_accounts Ä‘Æ°á»£c gá»i.")

    def open_browser_for_selected(self):
        QMessageBox.information(self, "Chá»©c nÄƒng", "Má»Ÿ trÃ¬nh duyá»‡t Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn.")
        print("[DEBUG] Chá»©c nÄƒng open_browser_for_selected Ä‘Æ°á»£c gá»i.")

    def logout_selected_accounts(self):
        self.update_account_table()
        QMessageBox.information(self, "Chá»©c nÄƒng", "ÄÄƒng xuáº¥t tÃ i khoáº£n Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn.")
        print("[DEBUG] Chá»©c nÄƒng logout_selected_accounts Ä‘Æ°á»£c gá»i.")

    def delete_selected_accounts(self):
        # XÃ³a cÃ¡c tÃ i khoáº£n Ä‘Ã£ Ä‘Æ°á»£c tick chá»n (checkbox)
        selected_accounts = [acc for acc in self.accounts if acc.get("selected")]
        if not selected_accounts:
            QMessageBox.warning(self, "XÃ³a tÃ i khoáº£n", "Vui lÃ²ng tick chá»n Ã­t nháº¥t má»™t tÃ i khoáº£n Ä‘á»ƒ xÃ³a.")
            return
        reply = QMessageBox.question(
            self, "XÃ¡c nháº­n", f"Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a {len(selected_accounts)} tÃ i khoáº£n Ä‘Ã£ chá»n?",
            QMessageBox.Yes | QMessageBox.No, QMessageBox.No
        )
        if reply == QMessageBox.Yes:
            self.accounts = [acc for acc in self.accounts if not acc.get("selected")]
            self.save_accounts()
            self.update_account_table()
            QMessageBox.information(self, "ThÃ nh cÃ´ng", "ÄÃ£ xÃ³a cÃ¡c tÃ i khoáº£n Ä‘Ã£ chá»n.")

    def select_selected_accounts(self):
        selected_rows = self.account_table.selectionModel().selectedRows()
        for index in selected_rows:
            row = index.row()
            if row < len(self.accounts):
                model_index = self.account_table.model().index(row, 0)
                self.account_table.model().setData(model_index, True, CheckboxDelegate.CheckboxStateRole)
                self.accounts[row]["selected"] = True
        self.save_accounts()
        self.update_account_table()
        # QMessageBox.information(self, "Chá»n tÃ i khoáº£n", f"ÄÃ£ chá»n {len(selected_rows)} tÃ i khoáº£n Ä‘Æ°á»£c bÃ´i Ä‘en.")
        print(f"[DEBUG] ÄÃ£ chá»n {len(selected_rows)} tÃ i khoáº£n Ä‘Æ°á»£c bÃ´i Ä‘en.")

    def deselect_selected_accounts(self):
        # Bá» chá»n cÃ¡c tÃ i khoáº£n Ä‘ang Ä‘Æ°á»£c bÃ´i Ä‘en (highlighted) vÃ  Ä‘ang hiá»ƒn thá»‹
        selected_rows = self.account_table.selectionModel().selectedRows()
        for index in selected_rows:
            row = index.row()
            if not self.account_table.isRowHidden(row):
                item_checkbox = self.account_table.item(row, 0)
                if item_checkbox:
                    model_index = self.account_table.model().index(row, 0)
                    self.account_table.model().setData(model_index, False, CheckboxDelegate.CheckboxStateRole)
                    username = self.account_table.item(row, 2).text()
                    for acc in self.accounts:
                        if acc.get("username", "") == username:
                            acc["selected"] = False
        self.save_accounts()
        self.update_account_table()
        print(f"[DEBUG] ÄÃ£ bá» chá»n cÃ¡c tÃ i khoáº£n Ä‘Æ°á»£c bÃ´i Ä‘en vÃ  Ä‘ang hiá»ƒn thá»‹.")

    def deselect_all_accounts(self):
        # Bá» chá»n táº¥t cáº£ tÃ i khoáº£n Ä‘Ã£ Ä‘Æ°á»£c tick chá»n (chá»‰ cÃ¡c dÃ²ng Ä‘ang hiá»ƒn thá»‹)
        for row_idx in range(self.account_table.rowCount()):
            if not self.account_table.isRowHidden(row_idx):
                item = self.account_table.item(row_idx, 0)
                if item:
                    model_index = self.account_table.model().index(row_idx, 0)
                    self.account_table.model().setData(model_index, False, CheckboxDelegate.CheckboxStateRole)
                    username = self.account_table.item(row_idx, 2).text()
                    for acc in self.accounts:
                        if acc.get("username", "") == username:
                            acc["selected"] = False
        self.save_accounts()
        self.update_account_table()
        print(f"[DEBUG] ÄÃ£ bá» chá»n táº¥t cáº£ tÃ i khoáº£n Ä‘ang hiá»ƒn thá»‹.")

    def add_selected_to_folder(self, folder_name):
        # GÃ¡n táº¥t cáº£ tÃ i khoáº£n Ä‘ang tick chá»n vÃ o folder_name
        selected_accounts = [acc for acc in self.accounts if acc.get("selected")]
        if not selected_accounts:
            QMessageBox.warning(self, "GÃ¡n thÆ° má»¥c", "Vui lÃ²ng tick chá»n Ã­t nháº¥t má»™t tÃ i khoáº£n Ä‘á»ƒ gÃ¡n vÃ o thÆ° má»¥c.")
            return
        for acc in selected_accounts:
            username = acc.get("username", "")
            if username:
                self.folder_map[username] = folder_name
        self.save_folder_map()
        self.update_account_table()
        QMessageBox.information(self, "ThÃ nh cÃ´ng", f"ÄÃ£ gÃ¡n {len(selected_accounts)} tÃ i khoáº£n vÃ o thÆ° má»¥c '{folder_name}'.")

    def remove_selected_from_folder(self):
        # ÄÆ°a táº¥t cáº£ tÃ i khoáº£n Ä‘ang tick chá»n vá» thÆ° má»¥c 'Tá»•ng' náº¿u Ä‘ang á»Ÿ thÆ° má»¥c khÃ¡c
        selected_accounts = [acc for acc in self.accounts if acc.get("selected")]
        if not selected_accounts:
            QMessageBox.warning(self, "Bá» gÃ¡n thÆ° má»¥c", "Vui lÃ²ng tick chá»n Ã­t nháº¥t má»™t tÃ i khoáº£n Ä‘á»ƒ bá» gÃ¡n.")
            return
        count = 0
        for acc in selected_accounts:
            username = acc.get("username", "")
            if username and self.folder_map.get(username) != "Tá»•ng":
                self.folder_map[username] = "Tá»•ng"
                count += 1
        self.save_folder_map()
        self.update_account_table()
        QMessageBox.information(self, "ThÃ nh cÃ´ng", f"ÄÃ£ bá» gÃ¡n {count} tÃ i khoáº£n khá»i cÃ¡c thÆ° má»¥c.")

    def delete_selected_folder(self):
        QMessageBox.information(self, "Chá»©c nÄƒng", "XÃ³a thÆ° má»¥c Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn.")
        print("[DEBUG] Chá»©c nÄƒng delete_selected_folder Ä‘Æ°á»£c gá»i.")

    def set_account_status_selected(self, status):
        selected_accounts = [acc for acc in self.accounts if acc.get("selected")]
        if not selected_accounts:
            QMessageBox.warning(self, "Chuyá»ƒn tráº¡ng thÃ¡i", "Vui lÃ²ng tick chá»n Ã­t nháº¥t má»™t tÃ i khoáº£n.")
            return
        for acc in selected_accounts:
            acc["status"] = status
        self.save_accounts()
        self.update_account_table()
        QMessageBox.information(self, "ThÃ nh cÃ´ng", f"ÄÃ£ chuyá»ƒn tráº¡ng thÃ¡i {len(selected_accounts)} tÃ i khoáº£n sang '{status}'.")

    def update_selected_proxy_info(self):
        import re
        selected_accounts = [acc for acc in self.accounts if acc.get("selected")]
        if not selected_accounts:
            QMessageBox.warning(self, "Cáº­p nháº­t Proxy", "Vui lÃ²ng tick chá»n Ã­t nháº¥t má»™t tÃ i khoáº£n.")
            return
        proxy, ok = QInputDialog.getText(self, "Nháº­p Proxy", "Nháº­p proxy (ip:port hoáº·c ip:port:user:pass):")
        if not ok or not proxy.strip():
            return
        # Kiá»ƒm tra Ä‘á»‹nh dáº¡ng proxy
        pattern = r'^(\d{1,3}\.){3}\d{1,3}:\d{2,5}(:\w+:\w+)?$'
        if not re.match(pattern, proxy.strip()):
            QMessageBox.warning(self, "Lá»—i", "Proxy khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng!\nÄá»‹nh dáº¡ng há»£p lá»‡: ip:port hoáº·c ip:port:user:pass")
            return
        for acc in selected_accounts:
            acc["proxy"] = proxy.strip()
        self.save_accounts()
        self.update_account_table()
        QMessageBox.information(self, "ThÃ nh cÃ´ng", f"ÄÃ£ cáº­p nháº­t proxy cho {len(selected_accounts)} tÃ i khoáº£n.")

    def open_selected_user_data_folder(self):
        QMessageBox.information(self, "Chá»©c nÄƒng", "Má»Ÿ thÆ° má»¥c UserData Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn.")
        print("[DEBUG] Chá»©c nÄƒng open_selected_user_data_folder Ä‘Æ°á»£c gá»i.")

    def export_accounts(self):
        """Xuáº¥t danh sÃ¡ch tÃ i khoáº£n ra file."""
        file_path, _ = QFileDialog.getSaveFileName(self, "Xuáº¥t tÃ i khoáº£n", "", "JSON Files (*.json)")
        if file_path:
            try:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(self.accounts, f, ensure_ascii=False, indent=4)
                QMessageBox.information(self, "ThÃ nh cÃ´ng", "ÄÃ£ xuáº¥t tÃ i khoáº£n thÃ nh cÃ´ng!")
            except Exception as e:
                QMessageBox.critical(self, "Lá»—i", f"KhÃ´ng thá»ƒ xuáº¥t tÃ i khoáº£n: {str(e)}")

    def toggle_stealth_mode(self):
        """Báº­t/táº¯t cháº¿ Ä‘á»™ áº©n danh."""
        self.stealth_mode_enabled = not self.stealth_mode_enabled
        status = "báº­t" if self.stealth_mode_enabled else "táº¯t"
        QMessageBox.information(self, "ThÃ´ng bÃ¡o", f"ÄÃ£ {status} cháº¿ Ä‘á»™ áº©n danh!")

    def delete_all_accounts(self):
        """XÃ³a táº¥t cáº£ tÃ i khoáº£n."""
        reply = QMessageBox.question(self, "XÃ¡c nháº­n", "Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a táº¥t cáº£ tÃ i khoáº£n?",
                                     QMessageBox.Yes | QMessageBox.No, QMessageBox.No)
        if reply == QMessageBox.Yes:
            self.accounts.clear()
            self.save_accounts()
            self.update_account_table()
            QMessageBox.information(self, "ThÃ nh cÃ´ng", "ÄÃ£ xÃ³a táº¥t cáº£ tÃ i khoáº£n!")

    def close_popups(self, driver):
        # import time  # XÃ“A DÃ’NG NÃ€Y
        from selenium.webdriver.common.by import By
        close_selectors = [
            # Banner "Chrome controlled"
            "//div[contains(@class, 'controlled-indicator')]//button",
            "//div[contains(text(),'è‡ªåŠ¨æµ‹è¯•è½¯ä»¶')]/following-sibling::button",
            "//div[contains(text(),'is being controlled')]/following-sibling::button",
            # Cookie/terms
            "//button[contains(@aria-label, 'SchlieÃŸen')]",
            "//button[contains(@aria-label, 'Close')]",
            "//button[contains(@aria-label, 'å…³é—­')]",
            "//button[contains(text(), 'Ã—')]",
            "//button[text()='OK']",
            "//button[text()='Accept']",
            "//button[text()='Allow all cookies']",
            "//button[text()='Cho phÃ©p táº¥t cáº£ cookie']",
            "//button[contains(text(), 'Akzeptieren')]",
        ]
        for _ in range(3):  # Láº·p láº¡i 3 láº§n Ä‘á»ƒ cháº¯c cháº¯n táº¯t háº¿t
            for sel in close_selectors:
                try:
                    btn = driver.find_element(By.XPATH, sel)
                    btn.click()
                    print(f"[DEBUG] ÄÃ£ táº¯t popup vá»›i selector: {sel}")
                    # time.sleep(0.2)  # XÃ“A DÃ’NG NÃ€Y
                except Exception:
                    continue
        # Inject CSS áº©n
                    # Inject CSS áº©n banner "Chrome controlled" náº¿u cÃ²n sÃ³t
                try:
                    driver.execute_script("""
                    var el = document.querySelector('div.controlled-indicator');
                    if (el) { el.style.display = 'none'; }
                    """)
                except Exception:
                    pass

    def save_folder_map(self):
        if hasattr(self, 'folder_map_file'):
            try:
                with open(self.folder_map_file, "w", encoding="utf-8") as f:
                    json.dump(self.folder_map, f, ensure_ascii=False, indent=2)
            except Exception as e:
                print(f"[ERROR] Lá»—i khi lÆ°u folder_map: {e}")

    def on_proxy_switch_changed(self, value):
        self.use_proxy = bool(value)
        self.update_proxy_switch_label()
        # LÆ°u tráº¡ng thÃ¡i vÃ o file
        try:
            with open(self.settings_file, "w", encoding="utf-8") as f:
                json.dump({"use_proxy": self.use_proxy}, f)
        except Exception as e:
            print(f"[WARN] KhÃ´ng thá»ƒ lÆ°u tráº¡ng thÃ¡i sá»­ dá»¥ng proxy: {e}")
        print(f"[DEBUG] Tráº¡ng thÃ¡i sá»­ dá»¥ng proxy: {self.use_proxy}")

    def update_proxy_switch_label(self):
        if self.use_proxy:
            self.proxy_switch_label.setText("Proxy: ON")
            self.proxy_switch_label.setStyleSheet("color: #4CAF50; font-weight: bold;")
        else:
            self.proxy_switch_label.setText("Proxy: OFF")
            self.proxy_switch_label.setStyleSheet("color: #888; font-weight: bold;")

    def closeEvent(self, event):
        # LÆ°u tráº¡ng thÃ¡i sá»­ dá»¥ng proxy khi Ä‘Ã³ng á»©ng dá»¥ng
        try:
            with open(self.settings_file, "w", encoding="utf-8") as f:
                json.dump({"use_proxy": self.use_proxy}, f)
        except Exception as e:
            print(f"[WARN] KhÃ´ng thá»ƒ lÆ°u tráº¡ng thÃ¡i sá»­ dá»¥ng proxy khi Ä‘Ã³ng á»©ng dá»¥ng: {e}")
        super().closeEvent(event)

    def save_cookies(self, driver, username):
        os.makedirs('sessions', exist_ok=True)
        cookies = driver.get_cookies()
        with open(f'sessions/{username}_cookies.json', 'w', encoding='utf-8') as f:
            json.dump(cookies, f)

    def load_cookies(self, driver, username):
        cookies_path = f'sessions/{username}_cookies.json'
        if os.path.exists(cookies_path):
            with open(cookies_path, 'r', encoding='utf-8') as f:
                cookies = json.load(f)
            for cookie in cookies:
                # Selenium yÃªu cáº§u pháº£i á»Ÿ Ä‘Ãºng domain má»›i add Ä‘Æ°á»£c cookie
                driver.add_cookie(cookie)
            return True
        return False

    def show_captcha_dialog_safe(self, driver, username, dialog_type="captcha"):
        """Hiá»ƒn thá»‹ dialog captcha/checkpoint má»™t cÃ¡ch an toÃ n"""
        try:
            from PySide6.QtWidgets import QMessageBox
            
            # Chá»‰ hiá»ƒn thá»‹ dialog náº¿u chÆ°a cÃ³ dialog nÃ o Ä‘ang má»Ÿ
            if hasattr(self, '_captcha_dialog_active') and self._captcha_dialog_active:
                print("[DEBUG] Captcha dialog Ä‘Ã£ Ä‘ang má»Ÿ, bá» qua")
                return True
                
            self._captcha_dialog_active = True
            
            try:
                msg_box = QMessageBox(self)
                msg_box.setWindowTitle("Captcha/XÃ¡c minh")
                
                if dialog_type == "captcha":
                    msg_box.setText(f"PhÃ¡t hiá»‡n captcha/checkpoint cho tÃ i khoáº£n {username}.\n\n"
                                   "Vui lÃ²ng:\n"
                                   "1. Chuyá»ƒn sang cá»­a sá»• trÃ¬nh duyá»‡t\n"
                                   "2. Giáº£i captcha hoáº·c xÃ¡c minh\n"
                                   "3. Nháº¥n 'Tiáº¿p tá»¥c' khi hoÃ n táº¥t\n\n"
                                   "KHÃ”NG Ä‘Ã³ng trÃ¬nh duyá»‡t!")
                else:  # 2FA
                    msg_box.setText(f"PhÃ¡t hiá»‡n yÃªu cáº§u 2FA cho tÃ i khoáº£n {username}.\n\n"
                                   "Vui lÃ²ng:\n"
                                   "1. Chuyá»ƒn sang cá»­a sá»• trÃ¬nh duyá»‡t\n"
                                   "2. Nháº­p mÃ£ xÃ¡c minh 2FA\n"
                                   "3. Nháº¥n 'Tiáº¿p tá»¥c' khi hoÃ n táº¥t\n\n"
                                   "KHÃ”NG Ä‘Ã³ng trÃ¬nh duyá»‡t!")
                
                msg_box.setStandardButtons(QMessageBox.Ok | QMessageBox.Cancel)
                msg_box.button(QMessageBox.Ok).setText("Tiáº¿p tá»¥c")
                msg_box.button(QMessageBox.Cancel).setText("Bá» qua")
                
                # Äáº£m báº£o dialog luÃ´n á»Ÿ trÃªn cÃ¹ng
                msg_box.setWindowFlag(msg_box.windowFlags() | 0x00000008)  # WindowStaysOnTopHint
                
                # Hiá»ƒn thá»‹ dialog
                result = msg_box.exec()
                
                self._captcha_dialog_active = False
                
                if result == QMessageBox.Ok:
                    print(f"[DEBUG] User chá»n tiáº¿p tá»¥c xá»­ lÃ½ {dialog_type} cho {username}")
                    return True
                else:
                    print(f"[DEBUG] User chá»n bá» qua {dialog_type} cho {username}")
                    return False
                    
            except Exception as e:
                print(f"[ERROR] Lá»—i khi hiá»ƒn thá»‹ dialog: {e}")
                self._captcha_dialog_active = False
                return False
            
        except Exception as e:
            print(f"[ERROR] Lá»—i trong show_captcha_dialog_safe: {e}")
            return False
    
    def check_login_success_after_captcha(self, driver, username):
        """Kiá»ƒm tra Ä‘Äƒng nháº­p thÃ nh cÃ´ng sau khi xá»­ lÃ½ captcha"""
        try:
            print(f"[INFO] Kiá»ƒm tra Ä‘Äƒng nháº­p sau xá»­ lÃ½ captcha cho {username}")
            
            # Äá»£i má»™t chÃºt Ä‘á»ƒ trang táº£i
            time.sleep(2)
            
            # Sá»­ dá»¥ng hÃ m kiá»ƒm tra nhanh
            return self.quick_login_check(driver)
            
        except Exception as e:
            print(f"[ERROR] Lá»—i khi kiá»ƒm tra Ä‘Äƒng nháº­p sau captcha: {e}")
            return False

    def verify_login_and_collect_info_fast(self, driver, username, account):
        """XÃ¡c minh Ä‘Äƒng nháº­p vÃ  thu tháº­p thÃ´ng tin nhanh chÃ³ng"""
        try:
            print(f"[INFO] Báº¯t Ä‘áº§u xÃ¡c minh Ä‘Äƒng nháº­p nhanh cho {username}")
            
            # BÆ°á»›c 1: Kiá»ƒm tra nhanh Ä‘Ã£ Ä‘Äƒng nháº­p chÆ°a
            login_verified = self.quick_login_check(driver)
            if not login_verified:
                print(f"[WARN] ChÆ°a Ä‘Äƒng nháº­p thÃ nh cÃ´ng cho {username}")
                return False
            
            # BÆ°á»›c 2: Thu tháº­p thÃ´ng tin cÆ¡ báº£n nhanh
            info = self.collect_basic_info_fast(driver, username)
            
            # BÆ°á»›c 3: Cáº­p nháº­t thÃ´ng tin vÃ o account
            self.update_account_info(account, info)
            
            # BÆ°á»›c 4: LÆ°u cookies Ä‘á»ƒ láº§n sau Ä‘Äƒng nháº­p nhanh hÆ¡n
            self.save_cookies(driver, username)
            
            # BÆ°á»›c 5: Cáº­p nháº­t UI
            account["status"] = "ÄÃ£ Ä‘Äƒng nháº­p"
            account["last_action"] = f"ÄÄƒng nháº­p thÃ nh cÃ´ng lÃºc {time.strftime('%H:%M:%S')}"
            from PySide6.QtCore import QMetaObject, Qt
            self.status_updated.emit(username, account["status"])
            
            print(f"[SUCCESS] XÃ¡c minh Ä‘Äƒng nháº­p thÃ nh cÃ´ng cho {username}")
            return True
            
        except Exception as e:
            print(f"[ERROR] Lá»—i khi xÃ¡c minh Ä‘Äƒng nháº­p cho {username}: {e}")
            return False
    
    def quick_login_check(self, driver):
        """Kiá»ƒm tra nhanh Ä‘Ã£ Ä‘Äƒng nháº­p thÃ nh cÃ´ng chÆ°a"""
        try:
            # Kiá»ƒm tra URL trÆ°á»›c
            current_url = driver.current_url.lower()
            if any(x in current_url for x in ["login", "challenge", "checkpoint"]):
                return False
            
            # Kiá»ƒm tra cÃ¡c dáº¥u hiá»‡u Ä‘Äƒng nháº­p thÃ nh cÃ´ng (theo thá»© tá»± Æ°u tiÃªn)
            login_indicators = [
                # 1. Home icon (nhanh nháº¥t)
                ("svg[aria-label='Home']", "Home icon"),
                ("svg[aria-label='Trang chá»§']", "Home icon (VI)"),
                
                # 2. Navigation bar
                ("nav[role='navigation']", "Navigation bar"),
                
                # 3. User avatar
                ("img[alt*='profile']", "Profile avatar"),
                ("span[data-testid='user-avatar']", "User avatar"),
                
                # 4. Story tray
                ("div[role='button'][tabindex='0']", "Story tray"),
            ]
            
            for selector, description in login_indicators:
                try:
                    element = driver.find_element(By.CSS_SELECTOR, selector)
                    if element.is_displayed():
                        print(f"[DEBUG] ÄÄƒng nháº­p xÃ¡c nháº­n qua {description}")
                        return True
                except Exception:
                    continue
            
            return False
            
        except Exception as e:
            print(f"[ERROR] Lá»—i khi kiá»ƒm tra Ä‘Äƒng nháº­p nhanh: {e}")
            return False
    
    def collect_basic_info_fast(self, driver, username):
        """Thu tháº­p thÃ´ng tin cÆ¡ báº£n nhanh chÃ³ng"""
        info = {
            "username": username,
            "profile_url": "",
            "followers": "N/A",
            "following": "N/A", 
            "posts": "N/A",
            "bio": "",
            "verified": False,
            "private": False
        }
        
        try:
            # Láº¥y URL hiá»‡n táº¡i
            current_url = driver.current_url
            if "instagram.com" in current_url:
                info["profile_url"] = current_url
            
            # Thá»­ truy cáº­p profile nhanh (náº¿u chÆ°a á»Ÿ profile)
            if f"instagram.com/{username}" not in current_url.lower():
                try:
                    driver.get(f"https://www.instagram.com/{username}/")
                    time.sleep(2)  # Äá»£i trang táº£i
                except Exception:
                    pass
            
            # Thu tháº­p thÃ´ng tin tá»« profile (vá»›i timeout ngáº¯n)
            try:
                # Followers, Following, Posts
                stats_selectors = [
                    "main section ul li a span",
                    "header section ul li a span",
                    "article header div span"
                ]
                
                for selector in stats_selectors:
                    try:
                        stats = driver.find_elements(By.CSS_SELECTOR, selector)
                        if len(stats) >= 3:
                            info["posts"] = stats[0].text.strip()
                            info["followers"] = stats[1].text.strip() 
                            info["following"] = stats[2].text.strip()
                            break
                    except Exception:
                        continue
                
                # Bio
                try:
                    bio_element = driver.find_element(By.CSS_SELECTOR, "header section div span")
                    info["bio"] = bio_element.text.strip()[:100]  # Giá»›i háº¡n 100 kÃ½ tá»±
                except Exception:
                    pass
                
                # Verified badge
                try:
                    verified = driver.find_elements(By.CSS_SELECTOR, "svg[aria-label*='Verified']")
                    info["verified"] = len(verified) > 0
                except Exception:
                    pass
                
                # Private account
                try:
                    private_text = driver.page_source.lower()
                    info["private"] = "this account is private" in private_text
                except Exception:
                    pass
                    
            except Exception as e:
                print(f"[DEBUG] KhÃ´ng thu tháº­p Ä‘Æ°á»£c thÃ´ng tin chi tiáº¿t: {e}")
            
            print(f"[DEBUG] Thu tháº­p info: {info}")
            return info
            
        except Exception as e:
            print(f"[ERROR] Lá»—i khi thu tháº­p thÃ´ng tin: {e}")
            return info
    
    def update_account_info(self, account, info):
        """Cáº­p nháº­t thÃ´ng tin vÃ o account"""
        try:
            account["profile_url"] = info.get("profile_url", "")
            account["followers"] = info.get("followers", "N/A")
            account["following"] = info.get("following", "N/A")
            account["posts"] = info.get("posts", "N/A")
            account["bio"] = info.get("bio", "")
            account["verified"] = info.get("verified", False)
            account["private"] = info.get("private", False)
            account["last_updated"] = time.strftime("%Y-%m-%d %H:%M:%S")
            
            print(f"[DEBUG] ÄÃ£ cáº­p nháº­t thÃ´ng tin cho {account.get('username')}")
            
        except Exception as e:
            print(f"[ERROR] Lá»—i khi cáº­p nháº­t thÃ´ng tin account: {e}")
    
    def debug_instagram_dom(self, driver, username):
        """Debug DOM structure cá»§a Instagram Ä‘á»ƒ hiá»ƒu layout"""
        try:
            print(f"[DEBUG] ===== DEBUG DOM STRUCTURE CHO {username} =====")
            
            # TÃ¬m táº¥t cáº£ cÃ¡c link href="/"
            home_links = driver.find_elements(By.CSS_SELECTOR, "a[href='/']")
            print(f"[DEBUG] TÃ¬m tháº¥y {len(home_links)} link href='/'")
            for i, link in enumerate(home_links[:5]):  # Chá»‰ log 5 link Ä‘áº§u
                try:
                    location = link.location
                    size = link.size
                    is_displayed = link.is_displayed()
                    print(f"[DEBUG] Home link {i+1}: X={location['x']}, Y={location['y']}, W={size['width']}, H={size['height']}, Visible={is_displayed}")
                    print(f"[DEBUG] HTML: {link.get_attribute('outerHTML')[:300]}...")
                except Exception as e:
                    print(f"[DEBUG] Lá»—i khi debug home link {i+1}: {e}")
            
            # TÃ¬m táº¥t cáº£ cÃ¡c link explore
            explore_links = driver.find_elements(By.CSS_SELECTOR, "a[href*='explore']")
            print(f"[DEBUG] TÃ¬m tháº¥y {len(explore_links)} link explore")
            for i, link in enumerate(explore_links[:5]):  # Chá»‰ log 5 link Ä‘áº§u
                try:
                    location = link.location
                    size = link.size
                    is_displayed = link.is_displayed()
                    print(f"[DEBUG] Explore link {i+1}: X={location['x']}, Y={location['y']}, W={size['width']}, H={size['height']}, Visible={is_displayed}")
                    print(f"[DEBUG] HTML: {link.get_attribute('outerHTML')[:300]}...")
                except Exception as e:
                    print(f"[DEBUG] Lá»—i khi debug explore link {i+1}: {e}")
            
            # TÃ¬m táº¥t cáº£ SVG icons
            svg_icons = driver.find_elements(By.CSS_SELECTOR, "svg")
            print(f"[DEBUG] TÃ¬m tháº¥y {len(svg_icons)} SVG icons")
            home_svg_count = 0
            explore_svg_count = 0
            for i, svg in enumerate(svg_icons[:20]):  # Chá»‰ log 20 SVG Ä‘áº§u
                try:
                    aria_label = svg.get_attribute('aria-label') or ""
                    location = svg.location
                    is_displayed = svg.is_displayed()
                    if is_displayed and location['y'] > 0:  # Chá»‰ log SVG hiá»ƒn thá»‹
                        if any(keyword in aria_label.lower() for keyword in ['home', 'trang chá»§']):
                            home_svg_count += 1
                            print(f"[DEBUG] HOME SVG {home_svg_count}: aria-label='{aria_label}', X={location['x']}, Y={location['y']}")
                        elif any(keyword in aria_label.lower() for keyword in ['search', 'explore', 'tÃ¬m kiáº¿m', 'khÃ¡m phÃ¡']):
                            explore_svg_count += 1
                            print(f"[DEBUG] EXPLORE SVG {explore_svg_count}: aria-label='{aria_label}', X={location['x']}, Y={location['y']}")
                except Exception as e:
                    continue
                    
            print(f"[DEBUG] Tá»•ng: {home_svg_count} Home SVG, {explore_svg_count} Explore SVG")
            print(f"[DEBUG] ===== Káº¾T THÃšC DEBUG DOM =====")
            
        except Exception as e:
            print(f"[DEBUG] Lá»—i khi debug DOM: {e}")

    def check_home_and_explore_icons(self, driver):
        """Kiá»ƒm tra icon ngÃ´i nhÃ  vÃ  la bÃ n á»Ÿ Instagram (app mode + desktop mode)"""
        try:
            print("[DEBUG] Äang kiá»ƒm tra icon ngÃ´i nhÃ  vÃ  la bÃ n á»Ÿ Instagram...")
            print(f"[DEBUG] URL hiá»‡n táº¡i: {driver.current_url}")
            
            # ThÃªm debug vá» page source
            try:
                page_source = driver.page_source
                print(f"[DEBUG] Page source length: {len(page_source)}")
                if "instagram.com" in page_source.lower():
                    print("[DEBUG] âœ… Trang Instagram Ä‘Ã£ load")
                else:
                    print("[DEBUG] âŒ Trang Instagram chÆ°a load Ä‘Ãºng")
            except:
                pass
            
            # THá»¨ NHáº¤T: Check icon Home (ngÃ´i nhÃ ) - má»Ÿ rá»™ng cho app mode
            home_icon_selectors = [
                # Instagram app mode vÃ  desktop mode
                "a[href='/'] svg",
                "a[href='/'][role='link'] svg",
                "a[href='/'][aria-label*='Home'] svg",
                "a[href='/'][aria-label*='Trang chá»§'] svg",
                # Aria labels cho home icon
                "svg[aria-label='Home']",
                "svg[aria-label='Trang chá»§']",
                "svg[aria-label*='Home']",
                "svg[aria-label*='Trang chá»§']",
                # Bottom navigation bar
                "div[role='tablist'] a[href='/'] svg",
                "div[role='tablist'] svg[aria-label='Home']",
                "div[role='tablist'] svg[aria-label='Trang chá»§']",
                "nav a[href='/'] svg", 
                "nav svg[aria-label='Home']",
                # Navigation containers
                "nav[role='navigation'] a[href='/'] svg",
                "div[class*='nav'] a[href='/'] svg",
                "div[class*='bottom'] a[href='/'] svg",
                # Mobile/app mode specific
                "div[class*='mobile'] a[href='/'] svg",
                "section a[href='/'] svg",
                # Generic navigation
                "[role='navigation'] a[href='/'] svg",
                "[role='tablist'] a[href='/'] svg"
            ]
            
            home_found = False
            home_location = None
            
            for selector in home_icon_selectors:
                try:
                    home_icons = driver.find_elements(By.CSS_SELECTOR, selector)
                    for icon in home_icons:
                        if icon.is_displayed():
                            location = icon.location
                            print(f"[DEBUG] TÃ¬m tháº¥y Home icon táº¡i vá»‹ trÃ­ X={location['x']}, Y={location['y']}")
                            home_found = True
                            home_location = location
                            break
                except Exception as e:
                    print(f"[DEBUG] Lá»—i khi tÃ¬m home icon vá»›i selector {selector}: {e}")
                    continue
                if home_found:
                    break
            
            if not home_found:
                print("[DEBUG] âŒ KhÃ´ng tÃ¬m tháº¥y Home icon")
                # Debug thÃªm vá» DOM structure
                try:
                    all_links = driver.find_elements(By.CSS_SELECTOR, "a[href='/']")
                    print(f"[DEBUG] TÃ¬m tháº¥y {len(all_links)} link href='/'")
                    for i, link in enumerate(all_links[:3]):  # Chá»‰ log 3 link Ä‘áº§u
                        print(f"[DEBUG] Link {i+1}: {link.get_attribute('outerHTML')[:200]}...")
                except:
                    pass
                return False
            
            # THá»¨ HAI: Check icon Explore/Search (la bÃ n) - má»Ÿ rá»™ng cho app mode
            explore_icon_selectors = [
                # Instagram app mode vÃ  desktop mode
                "a[href='/explore/'] svg",
                "a[href*='explore'] svg",
                "a[href='/explore/'][role='link'] svg",
                "a[href*='explore'][role='link'] svg",
                # Aria labels cho explore icon
                "svg[aria-label='Search and Explore']",
                "svg[aria-label='Search']",
                "svg[aria-label='Explore']", 
                "svg[aria-label='TÃ¬m kiáº¿m']",
                "svg[aria-label='KhÃ¡m phÃ¡']",
                "svg[aria-label*='Search']",
                "svg[aria-label*='Explore']",
                "svg[aria-label*='TÃ¬m kiáº¿m']",
                # Bottom navigation explore
                "div[role='tablist'] a[href='/explore/'] svg",
                "div[role='tablist'] a[href*='explore'] svg",
                "div[role='tablist'] svg[aria-label='Search']",
                "div[role='tablist'] svg[aria-label='Explore']",
                "div[role='tablist'] svg[aria-label='Search and Explore']",
                "nav a[href='/explore/'] svg",
                "nav a[href*='explore'] svg",
                "nav svg[aria-label='Search']",
                "nav svg[aria-label='Explore']",
                # Navigation containers
                "nav[role='navigation'] a[href*='explore'] svg",
                "div[class*='nav'] a[href*='explore'] svg",
                "div[class*='bottom'] a[href*='explore'] svg",
                # Mobile/app mode specific
                "div[class*='mobile'] a[href*='explore'] svg",
                "section a[href*='explore'] svg",
                # Generic navigation
                "[role='navigation'] a[href*='explore'] svg",
                "[role='tablist'] a[href*='explore'] svg"
            ]
            
            explore_found = False
            
            for selector in explore_icon_selectors:
                try:
                    explore_icons = driver.find_elements(By.CSS_SELECTOR, selector)
                    for icon in explore_icons:
                        if icon.is_displayed():
                            location = icon.location
                            print(f"[DEBUG] TÃ¬m tháº¥y Explore icon táº¡i vá»‹ trÃ­ X={location['x']}, Y={location['y']}")
                            # Kiá»ƒm tra icon cÃ³ gáº§n home icon khÃ´ng (cÃ¹ng vÃ¹ng navigation)
                            if home_location:
                                x_diff = abs(location['x'] - home_location['x'])
                                y_diff = abs(location['y'] - home_location['y'])
                                print(f"[DEBUG] Khoáº£ng cÃ¡ch vá»›i Home icon: X={x_diff}, Y={y_diff}")
                                # Cho phÃ©p linh hoáº¡t hÆ¡n vá» vá»‹ trÃ­
                                if y_diff < 100:  # CÃ¹ng hÃ ng ngang (trong vÃ²ng 100px)
                                    print(f"[DEBUG] âœ… Explore icon á»Ÿ cÃ¹ng vÃ¹ng vá»›i Home icon")
                                    explore_found = True
                                    break
                            else:
                                # Náº¿u khÃ´ng cÃ³ home_location, cháº¥p nháº­n explore icon
                                explore_found = True
                                break
                except Exception as e:
                    print(f"[DEBUG] Lá»—i khi tÃ¬m explore icon vá»›i selector {selector}: {e}")
                    continue
                if explore_found:
                    break
            
            if not explore_found:
                print("[DEBUG] âŒ KhÃ´ng tÃ¬m tháº¥y Explore icon")
                # Debug thÃªm vá» DOM structure
                try:
                    all_explore_links = driver.find_elements(By.CSS_SELECTOR, "a[href*='explore']")
                    print(f"[DEBUG] TÃ¬m tháº¥y {len(all_explore_links)} link explore")
                    for i, link in enumerate(all_explore_links[:3]):  # Chá»‰ log 3 link Ä‘áº§u
                        print(f"[DEBUG] Explore link {i+1}: {link.get_attribute('outerHTML')[:200]}...")
                except:
                    pass
                return False
            
            print("[DEBUG] âœ… TÃ¬m tháº¥y cáº£ 2 icon: Home + Explore á»Ÿ Instagram")
            return True
            
        except Exception as e:
            print(f"[DEBUG] Lá»—i khi kiá»ƒm tra icons: {e}")
            return False
    
    def check_captcha_required(self, driver):
        """Kiá»ƒm tra xem cÃ³ pháº£i bÃ¡o giáº£i captcha khÃ´ng - CHá»ˆ KHI THáº¬T Sá»° CÃ“ CAPTCHA"""
        try:
            current_url = driver.current_url.lower()
            page_source = driver.page_source.lower()
            
            # ÄIá»€U KIá»†N 1: Kiá»ƒm tra URL cÃ³ chá»©a challenge/checkpoint - THáº¬T Sá»° QUAN TRá»ŒNG
            if any(x in current_url for x in ["challenge", "checkpoint"]):
                print(f"[DEBUG] URL chá»©a challenge/checkpoint: {current_url}")
                return True
            
            # ÄIá»€U KIá»†N 2: Kiá»ƒm tra cÃ³ iframe captcha tháº­t sá»±
            try:
                captcha_frames = driver.find_elements(By.CSS_SELECTOR, "iframe[src*='recaptcha'], iframe[src*='hcaptcha']")
                if captcha_frames:
                    print("[DEBUG] TÃ¬m tháº¥y iframe captcha tháº­t sá»±")
                    return True
            except:
                pass
            
            # ÄIá»€U KIá»†N 3: Kiá»ƒm tra cÃ³ text captcha challenge cá»¥ thá»ƒ
            specific_captcha_texts = [
                "please solve this captcha",
                "security check required", 
                "verify you're not a robot",
                "complete the security check",
                "we need to verify",
                "suspicious activity detected"
            ]
            
            for text in specific_captcha_texts:
                if text in page_source:
                    print(f"[DEBUG] TÃ¬m tháº¥y text captcha cá»¥ thá»ƒ: {text}")
                    return True
            
            # KHÃ”NG detect dá»±a trÃªn keywords chung chung ná»¯a
            return False
            
        except Exception as e:
            print(f"[DEBUG] Lá»—i khi kiá»ƒm tra captcha: {e}")
            return False
    
    def check_2fa_required(self, driver):
        """â­ Cáº¢I TIáº¾N: Kiá»ƒm tra xem cÃ³ pháº£i yÃªu cáº§u nháº­p 2FA khÃ´ng - NÃ‚NG CAP DETECTION"""
        try:
            print(f"[DEBUG] ğŸ” Báº¯t Ä‘áº§u kiá»ƒm tra 2FA...")
            current_url = driver.current_url.lower()
            print(f"[DEBUG] URL hiá»‡n táº¡i: {current_url}")
            
            # â­ BÆ¯á»šC 1: Kiá»ƒm tra URL patterns cho 2FA
            twofa_url_patterns = [
                "accounts/login/two_factor", 
                "challenge/", 
                "two_factor",
                "2fa",
                "verify"
            ]
            
            for pattern in twofa_url_patterns:
                if pattern in current_url:
                    print(f"[DEBUG] âœ… PHÃT HIá»†N 2FA tá»« URL pattern: {pattern}")
                    return True
            
            # â­ BÆ¯á»šC 2: Kiá»ƒm tra page source vá»›i keywords má»Ÿ rá»™ng
            try:
                page_source = driver.page_source.lower()
                print(f"[DEBUG] Page source length: {len(page_source)}")
                
                # Expanded 2FA keywords - bao gá»“m nhiá»u ngÃ´n ngá»¯ vÃ  biáº¿n thá»ƒ
                twofa_keywords = [
                    # English
                    "enter the code", "enter your code", "verification code", 
                    "security code", "authentication code", "login code",
                    "two-factor", "2fa", "authenticator", "google authenticator",
                    "text message", "sms code", "phone verification",
                    "confirm your identity", "verify your identity",
                    "enter the 6-digit code", "6-digit code",
                    
                    # Vietnamese
                    "nháº­p mÃ£", "mÃ£ xÃ¡c minh", "mÃ£ báº£o máº­t", "mÃ£ Ä‘Äƒng nháº­p",
                    "xÃ¡c thá»±c hai yáº¿u tá»‘", "nháº­p mÃ£ cá»§a báº¡n", "mÃ£ 6 chá»¯ sá»‘",
                    "tin nháº¯n vÄƒn báº£n", "xÃ¡c minh danh tÃ­nh",
                    
                    # German (Instagram thÆ°á»ng dÃ¹ng German)
                    "gib den code ein", "bestÃ¤tigungscode", "sicherheitscode",
                    "zwei-faktor", "authentifizierungscode", "telefon-bestÃ¤tigung",
                    
                    # French
                    "entrez le code", "code de vÃ©rification", "code de sÃ©curitÃ©",
                    "authentification Ã  deux facteurs", "code d'authentification",
                    
                    # Spanish
                    "introduce el cÃ³digo", "cÃ³digo de verificaciÃ³n", "cÃ³digo de seguridad",
                    "autenticaciÃ³n de dos factores", "cÃ³digo de autenticaciÃ³n",
                    
                    # Additional specific phrases
                    "we sent you a code", "check your phone", "check your messages",
                    "enter code from your authenticator app", "backup codes",
                    "use another verification method", "didn't get the code"
                ]
                
                for keyword in twofa_keywords:
                    if keyword in page_source:
                        print(f"[DEBUG] âœ… PHÃT HIá»†N 2FA tá»« keyword: '{keyword}'")
                        return True
                
            except Exception as e:
                print(f"[DEBUG] Lá»—i khi kiá»ƒm tra page source: {e}")
            
            # â­ BÆ¯á»šC 3: Kiá»ƒm tra input fields cho verification code
            try:
                print(f"[DEBUG] Kiá»ƒm tra input fields cho 2FA...")
                
                # CÃ¡c selector cho 2FA input fields
                twofa_input_selectors = [
                    # Standard input names
                    "input[name='verificationCode']",
                    "input[name='verification_code']", 
                    "input[name='code']",
                    "input[name='securityCode']",
                    "input[name='security_code']",
                    "input[name='authCode']",
                    "input[name='auth_code']",
                    "input[name='loginCode']",
                    "input[name='login_code']",
                    
                    # Placeholder-based selectors
                    "input[placeholder*='code']",
                    "input[placeholder*='Code']", 
                    "input[placeholder*='mÃ£']",
                    "input[placeholder*='MÃ£']",
                    "input[placeholder*='verification']",
                    "input[placeholder*='Verification']",
                    "input[placeholder*='security']",
                    "input[placeholder*='Security']",
                    "input[placeholder*='6-digit']",
                    "input[placeholder*='six digit']",
                    
                    # Instagram-specific selectors
                    "input[autocomplete='one-time-code']",
                    "input[inputmode='numeric'][maxlength='6']",
                    "input[type='text'][maxlength='6']",
                    "input[type='tel'][maxlength='6']",
                    "input[pattern='[0-9]*'][maxlength='6']",
                    
                    # Aria labels
                    "input[aria-label*='code']",
                    "input[aria-label*='Code']",
                    "input[aria-label*='verification']",
                    "input[aria-label*='Verification']",
                ]
                
                for selector in twofa_input_selectors:
                    try:
                        elements = driver.find_elements(By.CSS_SELECTOR, selector)
                        if elements:
                            for element in elements:
                                if element.is_displayed():
                                    print(f"[DEBUG] âœ… PHÃT HIá»†N 2FA tá»« input field: {selector}")
                                    # Debug thÃªm thÃ´ng tin
                                    try:
                                        placeholder = element.get_attribute('placeholder')
                                        name = element.get_attribute('name')
                                        print(f"[DEBUG] Input details - name: {name}, placeholder: {placeholder}")
                                    except:
                                        pass
                                    return True
                    except Exception as e:
                        continue
                        
            except Exception as e:
                print(f"[DEBUG] Lá»—i khi kiá»ƒm tra input fields: {e}")
            
            # â­ BÆ¯á»šC 4: Kiá»ƒm tra buttons/text liÃªn quan Ä‘áº¿n 2FA  
            try:
                print(f"[DEBUG] Kiá»ƒm tra buttons/text liÃªn quan 2FA...")
                
                # Text-based detection
                twofa_text_selectors = [
                    "div:contains('verification code')",
                    "div:contains('security code')",
                    "div:contains('enter the code')",
                    "div:contains('nháº­p mÃ£')",
                    "div:contains('mÃ£ xÃ¡c minh')",
                    "span:contains('6-digit')",
                    "span:contains('authenticator')",
                    "p:contains('sent you a code')",
                    "p:contains('check your phone')"
                ]
                
                for selector in twofa_text_selectors:
                    try:
                        elements = driver.find_elements(By.CSS_SELECTOR, selector)
                        if elements:
                            for element in elements:
                                if element.is_displayed() and element.text.strip():
                                    print(f"[DEBUG] âœ… PHÃT HIá»†N 2FA tá»« text element: {element.text[:50]}...")
                                    return True
                    except:
                        continue
                        
            except Exception as e:
                print(f"[DEBUG] Lá»—i khi kiá»ƒm tra text elements: {e}")
            
            # â­ BÆ¯á»šC 5: Kiá»ƒm tra title/heading cho 2FA page
            try:
                title = driver.title.lower()
                if any(word in title for word in ["verification", "2fa", "security", "code", "authenticate"]):
                    print(f"[DEBUG] âœ… PHÃT HIá»†N 2FA tá»« page title: {title}")
                    return True
                    
                # Check h1, h2, h3 headings
                for tag in ["h1", "h2", "h3"]:
                    headings = driver.find_elements(By.TAG_NAME, tag)
                    for heading in headings:
                        if heading.is_displayed():
                            text = heading.text.lower()
                            if any(word in text for word in ["verification", "security", "code", "authenticate", "two-factor"]):
                                print(f"[DEBUG] âœ… PHÃT HIá»†N 2FA tá»« heading: {text}")
                                return True
            except:
                pass
            
            print(f"[DEBUG] âŒ KhÃ´ng phÃ¡t hiá»‡n 2FA")
            return False
            
        except Exception as e:
            print(f"[ERROR] Lá»—i khi kiá»ƒm tra 2FA: {e}")
            import traceback
            traceback.print_exc()
            return False
    
    def check_identity_verification_required(self, driver):
        """Kiá»ƒm tra xem cÃ³ pháº£i yÃªu cáº§u xÃ¡c minh danh tÃ­nh khÃ´ng - CHá»ˆ KHI THáº¬T Sá»° Cáº¦N"""
        try:
            page_source = driver.page_source.lower()
            current_url = driver.current_url.lower()
            
            # â­ QUAN TRá»ŒNG: Náº¿u Ä‘Ã£ Ä‘Äƒng nháº­p thÃ nh cÃ´ng (cÃ³ icon home/explore) thÃ¬ KHÃ”NG cáº§n xÃ¡c minh
            try:
                home_icons = driver.find_elements(By.XPATH, "//a[@href='/']//svg[@aria-label='Home' or contains(@aria-label, 'Trang chá»§')]")
                explore_icons = driver.find_elements(By.XPATH, "//a[@href='/explore/']//svg[@aria-label='Explore' or contains(@aria-label, 'KhÃ¡m phÃ¡')]")
                
                if len(home_icons) > 0 and len(explore_icons) > 0:
                    print(f"[DEBUG] âœ… ÄÃƒ ÄÄ‚NG NHáº¬P THÃ€NH CÃ”NG - Bá» qua kiá»ƒm tra identity verification")
                    return False
            except:
                pass
            
            # â­ CHá»ˆ KIá»‚M TRA KHI URL CHá»¨A CHALLENGE/CHECKPOINT
            if not any(x in current_url for x in ["challenge", "checkpoint", "accounts/login"]):
                print(f"[DEBUG] âœ… URL khÃ´ng chá»©a challenge/checkpoint - Bá» qua kiá»ƒm tra identity verification")
                return False
            
            # â­ CHá»ˆ KIá»‚M TRA CÃC KEYWORDS Cá»¤ THá»‚ VÃ€ NGHIÃŠM TRá»ŒNG
            identity_verification_keywords = [
                "help us confirm your identity",
                "we need to verify your identity", 
                "confirm that it's you",
                "verify that it's you",
                "security check to verify your identity",
                "additional verification required",
                "confirm your identity to continue"
            ]
            
            for keyword in identity_verification_keywords:
                if keyword in page_source:
                    print(f"[DEBUG] ğŸ” PHÃT HIá»†N YÃŠU Cáº¦U XÃC MINH DANH TÃNH - Keyword: '{keyword}'")
                    return True
            
            print(f"[DEBUG] âœ… KhÃ´ng phÃ¡t hiá»‡n yÃªu cáº§u xÃ¡c minh danh tÃ­nh")
            return False
            
        except Exception as e:
            print(f"[DEBUG] Lá»—i khi kiá»ƒm tra identity verification: {e}")
            return False

    def check_account_locked(self, driver):
        """Kiá»ƒm tra xem cÃ³ pháº£i bá»‹ khÃ³a tÃ i khoáº£n khÃ´ng - Chá»‰ nhá»¯ng trÆ°á»ng há»£p tháº­t sá»± nghiÃªm trá»ng"""
        try:
            page_source = driver.page_source.lower()
            current_url = driver.current_url.lower()
            
            print(f"[DEBUG] Kiá»ƒm tra tÃ i khoáº£n bá»‹ khÃ³a - URL: {current_url}")
            
            # Kiá»ƒm tra cÃ¡c keywords vá» tÃ i khoáº£n bá»‹ khÃ³a - Má» Rá»˜NG CHO AUTOMATED BEHAVIOR
            locked_keywords = [
                # Standard account suspension messages
                "account has been disabled", "tÃ i khoáº£n Ä‘Ã£ bá»‹ vÃ´ hiá»‡u hÃ³a",
                "account has been locked", "tÃ i khoáº£n Ä‘Ã£ bá»‹ khÃ³a", 
                "we suspended your account", "chÃºng tÃ´i Ä‘Ã£ táº¡m ngÆ°ng tÃ i khoáº£n",
                "account suspended", "tÃ i khoáº£n bá»‹ táº¡m ngÆ°ng",
                "disabled for violating", "bá»‹ vÃ´ hiá»‡u hÃ³a vÃ¬ vi pháº¡m",
                "your account has been deactivated", "tÃ i khoáº£n Ä‘Ã£ bá»‹ há»§y kÃ­ch hoáº¡t",
                
                # AUTOMATED BEHAVIOR DETECTION - QUAN TRá»ŒNG NHáº¤T
                "we suspect automated behavior", "chÃºng tÃ´i nghi ngá» hÃ nh vi tá»± Ä‘á»™ng",
                "automated behavior on your account", "hÃ nh vi tá»± Ä‘á»™ng trÃªn tÃ i khoáº£n",
                "suspicious activity detected", "phÃ¡t hiá»‡n hoáº¡t Ä‘á»™ng Ä‘Ã¡ng nghi",
                "unusual activity on your account", "hoáº¡t Ä‘á»™ng báº¥t thÆ°á»ng trÃªn tÃ i khoáº£n",
                "temporarily restricted", "táº¡m thá»i bá»‹ háº¡n cháº¿",
                "permanently disabled", "vÃ´ hiá»‡u hÃ³a vÄ©nh viá»…n",
                
                # Additional patterns for account restrictions
                "violating our terms", "vi pháº¡m Ä‘iá»u khoáº£n cá»§a chÃºng tÃ´i",
                "against our community guidelines", "trÃ¡i vá»›i hÆ°á»›ng dáº«n cá»™ng Ä‘á»“ng",
                "review your account", "xem xÃ©t tÃ i khoáº£n cá»§a báº¡n",
                "account under review", "tÃ i khoáº£n Ä‘ang Ä‘Æ°á»£c xem xÃ©t",
                "terms of use", "Ä‘iá»u khoáº£n sá»­ dá»¥ng",
                
                # Checkpoint/Challenge related to account issues - CHá»ˆ NHá»®NG TRÆ¯á»œNG Há»¢P THáº¬T Sá»° NGHIÃŠM TRá»ŒNG
                "checkpoint required", "yÃªu cáº§u checkpoint"
                # Bá» "verify your identity" vÃ  "confirm your identity" - Ä‘Ã¢y chá»‰ lÃ  yÃªu cáº§u xÃ¡c minh, khÃ´ng pháº£i khÃ³a tÃ i khoáº£n
            ]
            
            # KIá»‚M TRA KEYWORDS
            for keyword in locked_keywords:
                if keyword in page_source:
                    print(f"[DEBUG] âŒ PHÃT HIá»†N TÃ€I KHOáº¢N Bá»Š KHÃ“A - Keyword: '{keyword}'")
                    return True
            
            # KIá»‚M TRA URL PATTERNS CHO ACCOUNT RESTRICTION
            restricted_url_patterns = [
                "accounts/suspended",
                "accounts/locked", 
                "accounts/disabled",
                "challenge/",
                "checkpoint/"
            ]
            
            for pattern in restricted_url_patterns:
                if pattern in current_url:
                    print(f"[DEBUG] âŒ PHÃT HIá»†N TÃ€I KHOáº¢N Bá»Š KHÃ“A - URL Pattern: '{pattern}'")
                    return True
            
            # KIá»‚M TRA CÃC ELEMENT Cá»¤ THá»‚ CHO ACCOUNT RESTRICTIONS
            try:
                # TÃ¬m cÃ¡c element cÃ³ text liÃªn quan Ä‘áº¿n account restrictions
                restriction_selectors = [
                    "div[role='main']",  # Main content area
                    "div[class*='error']",  # Error containers
                    "div[class*='warning']",  # Warning containers
                    "div[class*='notice']",  # Notice containers
                    "div[class*='alert']",  # Alert containers
                    "section[role='main']",  # Main section
                    "article",  # Article content
                    "main"  # Main element
                ]
                
                for selector in restriction_selectors:
                    try:
                        elements = driver.find_elements(By.CSS_SELECTOR, selector)
                        for element in elements:
                            if element.is_displayed():
                                element_text = element.text.lower()
                                # Kiá»ƒm tra text cÃ³ chá»©a keywords khÃ´ng
                                for keyword in locked_keywords:
                                    if keyword in element_text:
                                        print(f"[DEBUG] âŒ PHÃT HIá»†N TÃ€I KHOáº¢N Bá»Š KHÃ“A - Element text chá»©a: '{keyword}'")
                                        return True
                    except Exception:
                        continue
                        
            except Exception as e:
                print(f"[DEBUG] Lá»—i khi kiá»ƒm tra element restrictions: {e}")
            
            print(f"[DEBUG] âœ… KhÃ´ng phÃ¡t hiá»‡n tÃ i khoáº£n bá»‹ khÃ³a")
            return False
            
        except Exception as e:
            print(f"[DEBUG] Lá»—i khi kiá»ƒm tra account locked: {e}")
            return False

    def check_save_login_info(self, driver):
        """Kiá»ƒm tra xem cÃ³ pháº£i form lÆ°u thÃ´ng tin Ä‘Äƒng nháº­p khÃ´ng"""
        try:
            page_source = driver.page_source.lower()
            
            # Kiá»ƒm tra cÃ¡c keywords vá» form lÆ°u thÃ´ng tin Ä‘Äƒng nháº­p
            save_login_keywords = [
                "deine login-informationen speichern",  # German
                "save your login info", "save login info",  # English
                "enregistrer vos informations de connexion",  # French
                "salvar informaÃ§Ãµes de login",  # Portuguese
                "guardar informaciÃ³n de inicio de sesiÃ³n",  # Spanish
                "informationen speichern",  # German short
                "login-informationen",  # German
                "save login information",  # English
                "remember login",  # English
                "lÆ°u thÃ´ng tin Ä‘Äƒng nháº­p",  # Vietnamese
                "ghi nhá»› Ä‘Äƒng nháº­p"  # Vietnamese
            ]
            
            for keyword in save_login_keywords:
                if keyword in page_source:
                    print(f"[DEBUG] PhÃ¡t hiá»‡n form lÆ°u thÃ´ng tin Ä‘Äƒng nháº­p: {keyword}")
                    return True
            
            # Kiá»ƒm tra cÃ¡c button text cá»¥ thá»ƒ
            try:
                # TÃ¬m button "Informationen speichern" hoáº·c "Save Info"
                save_buttons = driver.find_elements(By.XPATH, "//button[contains(text(), 'Informationen speichern') or contains(text(), 'Save Info') or contains(text(), 'Jetzt nicht') or contains(text(), 'Not Now')]")
                if save_buttons:
                    print("[DEBUG] TÃ¬m tháº¥y button lÆ°u thÃ´ng tin Ä‘Äƒng nháº­p")
                    return True
                
                # Kiá»ƒm tra cÃ¡c selector khÃ¡c
                save_selectors = [
                    "button[type='button'][class*='_acan']",  # Instagram save button class
                    "div[role='button'][tabindex='0']",  # Instagram dialog buttons
                    "button:contains('speichern')",  # German save
                    "button:contains('Save')",  # English save
                    "button:contains('Not Now')",  # English not now
                    "button:contains('Jetzt nicht')"  # German not now
                ]
                
                for selector in save_selectors:
                    try:
                        elements = driver.find_elements(By.CSS_SELECTOR, selector)
                        if elements:
                            # Kiá»ƒm tra text cá»§a button
                            for element in elements:
                                text = element.text.lower()
                                if any(word in text for word in ["speichern", "save", "nicht", "not"]):
                                    print(f"[DEBUG] TÃ¬m tháº¥y button lÆ°u thÃ´ng tin: {text}")
                                    return True
                    except:
                        continue
                        
            except Exception as e:
                print(f"[DEBUG] Lá»—i khi tÃ¬m button lÆ°u thÃ´ng tin: {e}")
            
            return False
            
        except Exception as e:
            print(f"[DEBUG] Lá»—i khi kiá»ƒm tra save login info: {e}")
            return False

    def handle_save_login_info(self, driver, username):
        """Xá»­ lÃ½ form lÆ°u thÃ´ng tin Ä‘Äƒng nháº­p - chá»n 'KhÃ´ng lÆ°u' Ä‘á»ƒ tiáº¿p tá»¥c"""
        try:
            print(f"[INFO] Xá»­ lÃ½ form lÆ°u thÃ´ng tin Ä‘Äƒng nháº­p cho {username}")
            
            # TÃ¬m vÃ  click button "Jetzt nicht" (Not Now) hoáº·c "Nicht speichern"
            not_now_buttons = [
                "//button[contains(text(), 'Jetzt nicht')]",  # German "Not Now"
                "//button[contains(text(), 'Not Now')]",  # English "Not Now"
                "//button[contains(text(), 'Nicht speichern')]",  # German "Don't Save"
                "//button[contains(text(), \"Don't Save\")]",  # English "Don't Save"
                "//button[contains(text(), 'Skip')]",  # English "Skip"
                "//div[@role='button' and contains(text(), 'Jetzt nicht')]",  # German div button
                "//div[@role='button' and contains(text(), 'Not Now')]"  # English div button
            ]
            
            for xpath in not_now_buttons:
                try:
                    button = driver.find_element(By.XPATH, xpath)
                    if button.is_displayed() and button.is_enabled():
                        button.click()
                        print(f"[SUCCESS] ÄÃ£ click 'Not Now' cho form lÆ°u thÃ´ng tin Ä‘Äƒng nháº­p")
                        time.sleep(2)  # Chá» form Ä‘Ã³ng
                        return True
                except:
                    continue
            
            # Náº¿u khÃ´ng tÃ¬m tháº¥y button "Not Now", thá»­ tÃ¬m button Ä‘áº§u tiÃªn cÃ³ text phÃ¹ há»£p
            try:
                all_buttons = driver.find_elements(By.TAG_NAME, "button")
                for button in all_buttons:
                    text = button.text.lower()
                    if any(word in text for word in ["nicht", "not", "skip", "later", "nein"]):
                        if button.is_displayed() and button.is_enabled():
                            button.click()
                            print(f"[SUCCESS] ÄÃ£ click button '{button.text}' Ä‘á»ƒ bá» qua lÆ°u thÃ´ng tin")
                            time.sleep(2)
                            return True
            except:
                pass
            
            # Náº¿u váº«n khÃ´ng Ä‘Æ°á»£c, thá»­ nháº¥n ESC Ä‘á»ƒ Ä‘Ã³ng dialog
            try:
                driver.find_element(By.TAG_NAME, "body").send_keys(Keys.ESCAPE)
                print(f"[INFO] ÄÃ£ nháº¥n ESC Ä‘á»ƒ Ä‘Ã³ng form lÆ°u thÃ´ng tin")
                time.sleep(2)
                return True
            except:
                pass
            
            print(f"[WARN] KhÃ´ng thá»ƒ xá»­ lÃ½ form lÆ°u thÃ´ng tin Ä‘Äƒng nháº­p cho {username}")
            return False
            
        except Exception as e:
            print(f"[ERROR] Lá»—i khi xá»­ lÃ½ form lÆ°u thÃ´ng tin Ä‘Äƒng nháº­p: {e}")
            return False

    def close_browser_safely(self, driver, username):
        """â­ Tá»I Æ¯U: ÄÃ³ng trÃ¬nh duyá»‡t má»™t cÃ¡ch an toÃ n vÃ  nhanh chÃ³ng"""
        import threading
        import time
        
        def close_with_timeout():
            try:
                print(f"[INFO] ğŸ”„ Báº¯t Ä‘áº§u Ä‘Ã³ng trÃ¬nh duyá»‡t cho {username}")
                
                # BÆ°á»›c 1: ÄÃ³ng táº¥t cáº£ tabs ngoáº¡i trá»« tab chÃ­nh
                try:
                    handles = driver.window_handles
                    if len(handles) > 1:
                        for handle in handles[1:]:
                            try:
                                driver.switch_to.window(handle)
                                driver.close()
                            except:
                                continue
                        try:
                            driver.switch_to.window(handles[0])
                        except:
                            pass
                except Exception:
                    pass
                
                # BÆ°á»›c 2: Cleanup khÃ´ng cáº§n thiáº¿t - khÃ´ng xÃ³a cookies (Ä‘Ã£ lÆ°u rá»“i)
                try:
                    # Chá»‰ clear local storage Ä‘á»ƒ trÃ¡nh conflict
                    driver.execute_script("localStorage.clear();")
                except Exception:
                    pass
                
                # BÆ°á»›c 3: Quit driver chÃ­nh
                try:
                    driver.quit()
                    print(f"[INFO] âœ… ÄÃ£ Ä‘Ã³ng trÃ¬nh duyá»‡t thÃ nh cÃ´ng cho {username}")
                    return True
                except Exception as e:
                    print(f"[WARN] Lá»—i khi quit driver: {e}")
                
                # BÆ°á»›c 4: Force terminate náº¿u quit tháº¥t báº¡i
                try:
                    if hasattr(driver, 'service') and hasattr(driver.service, 'process'):
                        process = driver.service.process
                        if process and process.poll() is None:  # Process váº«n Ä‘ang cháº¡y
                            process.terminate()
                            # Chá» tá»‘i Ä‘a 2 giÃ¢y Ä‘á»ƒ process tá»± terminate
                            for i in range(20):
                                if process.poll() is not None:
                                    break
                                time.sleep(0.1)
                            
                            # Náº¿u váº«n chÆ°a terminate, kill force
                            if process.poll() is None:
                                process.kill()
                                print(f"[INFO] ğŸ”¥ ÄÃ£ force kill browser process cho {username}")
                            else:
                                print(f"[INFO] âš¡ ÄÃ£ terminate browser process cho {username}")
                except Exception as e2:
                    print(f"[WARN] Lá»—i khi terminate/kill process: {e2}")
                
                return True
                
            except Exception as e:
                print(f"[ERROR] Lá»—i khÃ´ng mong muá»‘n khi Ä‘Ã³ng trÃ¬nh duyá»‡t: {e}")
                return False
        
        # â­ Tá»I Æ¯U: Cháº¡y trong thread riÃªng vá»›i timeout ngáº¯n
        close_thread = threading.Thread(target=close_with_timeout, daemon=True)
        close_thread.start()
        
        # âš¡ Tá»I Æ¯U: Chá» tá»‘i Ä‘a 2 giÃ¢y Ä‘á»ƒ Ä‘Ã³ng browser (giáº£m tá»« 3 giÃ¢y)
        close_thread.join(timeout=2.0)
        
        if close_thread.is_alive():
            print(f"[WARN] â° Timeout khi Ä‘Ã³ng trÃ¬nh duyá»‡t cho {username} - tiáº¿p tá»¥c cháº¡y")
        else:
            print(f"[INFO] âœ¨ HoÃ n táº¥t Ä‘Ã³ng trÃ¬nh duyá»‡t cho {username}")

# HÃ m helper bá»• sung

def detect_checkpoint_or_captcha(driver):
    """PhÃ¡t hiá»‡n captcha/checkpoint má»™t cÃ¡ch chÃ­nh xÃ¡c"""
    try:
        current_url = driver.current_url.lower()
        
        # 1. Kiá»ƒm tra URL cÃ³ chá»©a challenge/checkpoint khÃ´ng
        if "challenge" in current_url or "checkpoint" in current_url:
            print("[DEBUG] PhÃ¡t hiá»‡n challenge/checkpoint tá»« URL")
            return True
            
        # 2. Kiá»ƒm tra iframe captcha thá»±c sá»±
        try:
            recaptcha_frames = driver.find_elements(By.CSS_SELECTOR, "iframe[src*='recaptcha']")
            hcaptcha_frames = driver.find_elements(By.CSS_SELECTOR, "iframe[src*='hcaptcha']")
            
            if recaptcha_frames or hcaptcha_frames:
                print("[DEBUG] PhÃ¡t hiá»‡n iframe captcha thá»±c sá»±")
                return True
        except Exception:
            pass
            
        # 3. Kiá»ƒm tra cÃ¡c text cá»¥ thá»ƒ vá» captcha/checkpoint (chá»‰ khi chÆ°a Ä‘Äƒng nháº­p)
        try:
            page_source = driver.page_source.lower()
            
            # Náº¿u Ä‘Ã£ cÃ³ home icon => Ä‘Ã£ Ä‘Äƒng nháº­p => khÃ´ng cáº§n kiá»ƒm tra captcha
            if "svg[aria-label='home']" in page_source or "aria-label=\"home\"" in page_source:
                return False
                
            # Chá»‰ kiá»ƒm tra captcha/checkpoint khi chÆ°a Ä‘Äƒng nháº­p
            specific_captcha_keywords = [
                "we need to make sure you're a real person",
                "help us confirm you're human", 
                "confirm that you're human",
                "are you a robot",
                "verify that you're human",
                "security check",
                "suspicious login attempt",
                "unusual activity",
                "checkpoint required",
                "account temporarily locked"
            ]
            
            for keyword in specific_captcha_keywords:
                if keyword in page_source:
                    print(f"[DEBUG] PhÃ¡t hiá»‡n captcha/checkpoint tá»« keyword: {keyword}")
                    return True
                    
        except Exception as e:
            print(f"[DEBUG] Lá»—i khi kiá»ƒm tra page source: {e}")
            
        # 4. Kiá»ƒm tra cÃ¡c element captcha cá»¥ thá»ƒ
        captcha_selectors = [
            "div[class*='captcha']",
            "div[class*='recaptcha']", 
            "div[class*='hcaptcha']",
            "div[id*='captcha']",
            "form[class*='checkpoint']",
            "div[class*='checkpoint']"
        ]
        
        for selector in captcha_selectors:
            try:
                elements = driver.find_elements(By.CSS_SELECTOR, selector)
                if elements and any(el.is_displayed() for el in elements):
                    print(f"[DEBUG] PhÃ¡t hiá»‡n element captcha: {selector}")
                    return True
            except Exception:
                continue
                
    except Exception as e:
        print(f"[DEBUG] Lá»—i trong detect_checkpoint_or_captcha: {e}")
        
    return False

def is_logged_in_desktop(driver):
    """Kiá»ƒm tra Ä‘Äƒng nháº­p desktop"""
    try:
        nav_divs = driver.find_elements(By.CLASS_NAME, "PolarisNavigationIcons")
        for nav in nav_divs:
            svgs = nav.find_elements(By.TAG_NAME, "svg")
            print(f"[DEBUG] Sá»‘ lÆ°á»£ng SVG trong PolarisNavigationIcons: {len(svgs)}")
            if len(svgs) >= 3:
                print("[DEBUG] ÄÃ£ nháº­n diá»‡n Ä‘á»§ 3 icon SVG Ä‘áº§u tiÃªn trong PolarisNavigationIcons (Home, Explore, Reels)")
                return True
        print("[DEBUG] KhÃ´ng tÃ¬m tháº¥y Ä‘á»§ 3 icon SVG trong PolarisNavigationIcons.")
    except Exception as e:
        print(f"[DEBUG] Lá»—i khi kiá»ƒm tra icon SVG menu: {e}")
    return False